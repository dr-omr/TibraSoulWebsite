<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="طِبرا: رحلتك نحو الشفاء الرقمي. مساحة آمنة للتأمل، كتابة اليوميات، وخلق أجواء صوتية مهدئة.">
    <meta name="keywords" content="الشفاء الرقمي, حديقة زن, يوميات ذكية, تأمل, طِبرا, TibraSoul, digital healing, zen garden, AI journal, meditation">
    <title>ṬibraSoul طِبرا | مساحتك للشفاء الرقمي</title>

    <!-- ==== استدعاء المكتبات الخارجية (CDN) ==== -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- مكتبات إضافية للميزات المتقدمة -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* CSS STYLES (يحتوي على كل التنسيقات المطلوبة للميزات الجديدة والقديمة) */
        :root {
            --primary-color: #5a6e5a; --secondary-color: #f4f1eb; --dark-color: #3c3c3c;
            --light-color: #FFFFFF; --text-color: #4a4a4a; --accent-color: #c8a07d;
            --font-body: 'Noto Kufi Arabic', sans-serif; --font-headings: 'Noto Kufi Arabic', sans-serif;
            --font-brand: 'Great Vibes', cursive; --container-width: 1140px; --transition-speed: 0.4s ease;
            --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-body); color: var(--text-color); line-height: 1.8; background-color: var(--secondary-color); direction: rtl; text-align: right; }
        .container { max-width: var(--container-width); margin: 0 auto; padding: 0 1.5rem; }
        .btn { display: inline-block; padding: 0.8rem 2.2rem; border-radius: 50px; font-weight: 700; transition: all var(--transition-speed); cursor: pointer; border: none; text-align: center; }
        .btn-primary { background-color: var(--primary-color); color: var(--light-color); box-shadow: 0 4px 15px rgba(90, 110, 90, 0.3); }
        .btn-primary:hover { background-color: #435243; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(90, 110, 90, 0.4); }
        .section-title { text-align: center; font-size: 2.8rem; margin-bottom: 1rem; position: relative; padding-bottom: 1rem; color: var(--dark-color); }
        .section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background-color: var(--accent-color); }
        .section-intro { text-align: center; max-width: 650px; margin: 0 auto 4rem auto; font-size: 1.1rem; }
        .content-section { padding: 6rem 0; }
        
        /* ======== Login Screen ======== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: url('https://images.unsplash.com/photo-1473170611423-22489201d961?q=80&w=2070&auto=format&fit=crop') no-repeat center center/cover;
            position: relative;
        }
        .login-container::after { content: ''; position: absolute; top:0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .login-box {
            padding: 3rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            text-align: center;
            z-index: 2;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-box .logo { font-family: var(--font-brand); font-size: 4rem; color: var(--dark-color); }
        .login-box p { margin: 1rem 0 2rem 0; font-size: 1.1rem; }
        .google-login-btn { background-color: #db4437; color: white; border: none; }
        .google-login-btn:hover { background-color: #c33d2e; }
        .google-login-btn i { margin-left: 10px; }
        #app-loader { font-size: 1.2rem; color: var(--primary-color); margin-top: 1rem; display: none; }

        /* ======== Main App Content (Hidden by default) ======== */
        #main-app-content { display: none; }
        .main-header { position: sticky; top:0; z-index: 100; padding: 1rem 0; background-color: rgba(244, 241, 235, 0.8); backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .main-header .container { display: flex; justify-content: space-between; align-items: center; }
        .logo-header { font-family: var(--font-brand); font-size: 2.5rem; color: var(--dark-color); }
        .main-nav a, .main-nav button { color: var(--text-color); background: none; border: none; cursor: pointer; font-size: 1rem; font-family: var(--font-body); margin-right: 1.5rem; transition: color var(--transition-speed); }
        .main-nav a:hover, .main-nav button:hover { color: var(--primary-color); }
        .user-profile-img { width: 40px; height: 40px; border-radius: 50%; margin-left: 10px; vertical-align: middle; }

        /* ======== Digital Zen Garden ======== */
        #zen-garden-section { position: relative; height: calc(100vh - 78px); background-color: #E6DBC9; overflow: hidden; }
        #zen-garden-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(0,0,0,0.5)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><path d="M16 14v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><path d="M12 10V4"></path><path d="M12 4L8 8"></path><path d="M12 4l4 4"></path></svg>'), auto; }
        .zen-controls { position: absolute; top: 2rem; right: 2rem; z-index: 10; background: rgba(255,255,255,0.7); padding: 1rem; border-radius: var(--border-radius); }
        .breathing-guide { position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 10; display: flex; flex-direction: column; align-items: center; }
        #breathing-circle { width: 100px; height: 100px; background-color: rgba(90, 110, 90, 0.5); border-radius: 50%; animation: breathe 8s ease-in-out infinite; }
        #breathing-text { color: var(--light-color); text-shadow: 1px 1px 3px rgba(0,0,0,0.5); margin-top: 1rem; font-size: 1.2rem; }
        @keyframes breathe { 0% { transform: scale(0.6); } 50% { transform: scale(1); } 100% { transform: scale(0.6); } }
        .affirmation { position: absolute; color: rgba(0,0,0,0.4); font-size: 1.5rem; z-index: 5; animation: float 30s linear infinite; white-space: nowrap; }
        @keyframes float { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
        
        /* ======== AI Journal ======== */
        #journal-section { background-color: var(--light-color); }
        .journal-container { display: flex; gap: 2rem; flex-wrap: wrap; }
        .journal-entries { flex: 1; min-width: 300px; }
        .journal-editor { flex: 1.5; background: #fff; padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 5px 20px rgba(0,0,0,0.05); min-width: 300px; }
        #journal-textarea { width: 100%; height: 250px; border: 1px solid #ddd; border-radius: var(--border-radius); padding: 1rem; font-family: var(--font-body); font-size: 1rem; resize: vertical; margin-bottom: 1rem; }
        #ai-analysis-result { background: var(--secondary-color); padding: 1.5rem; margin-top: 1.5rem; border-radius: var(--border-radius); min-height: 50px; font-style: italic; color: var(--primary-color); }
        
        /* ======== Soundscape Mixer ======== */
        #soundscape-section { background-color: #3c3c3c; color: var(--light-color); }
        #soundscape-section .section-title, #soundscape-section .section-intro { color: var(--light-color); }
        .soundscape-mixer { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2.5rem; max-width: 900px; margin: auto; }
        .sound-channel { background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: var(--border-radius); text-align: center; }
        .sound-channel label { display: block; margin-bottom: 1rem; font-size: 1.2rem; }
        .sound-channel input[type="range"] { width: 100%; cursor: pointer;}
        
        /* ======== Visual Journey Profile ======== */
        #profile-section { text-align: center; }
        #lottie-container { width: 100%; max-width: 500px; height: 500px; margin: 2rem auto; }
        .profile-stats { display: flex; justify-content: center; gap: 2rem; margin-top: 2rem; flex-wrap: wrap; }
        .stat-item { background: #fff; padding: 1rem 2rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-item span { display: block; font-size: 2rem; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>

    <!-- ==================== شاشة تسجيل الدخول ==================== -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-box">
                <h1 class="logo">ṬibraSoul</h1>
                <p>مساحتك الآمنة للشفاء الرقمي والنمو الداخلي</p>
                <button id="google-login-btn" class="btn google-login-btn">
                    <i class="fab fa-google"></i>
                    الدخول باستخدام جوجل
                </button>
                <div id="app-loader">
                    <p>جاري الدخول...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== محتوى التطبيق الرئيسي (مخفي) ==================== -->
    <div id="main-app-content">
        <header class="main-header">
            <div class="container">
                <a href="#zen-garden-section" class="logo-header">Ṭibra</a>
                <nav class="main-nav">
                    <a href="#zen-garden-section">حديقة زن</a>
                    <a href="#journal-section">يومياتي</a>
                    <a href="#soundscape-section">الأصوات</a>
                    <a href="#profile-section">رحلتي</a>
                    <span id="user-display">
                        <img id="user-profile-img" src="https://placehold.co/40x40/5a6e5a/f4f1eb?text=U" alt="صورة المستخدم" class="user-profile-img">
                        <span id="user-name"></span>
                    </span>
                    <button id="logout-btn">تسجيل الخروج</button>
                </nav>
            </div>
        </header>

        <main>
            <!-- ==================== الحديقة الرقمية التفاعلية ==================== -->
            <section id="zen-garden-section">
                <canvas id="zen-garden-canvas"></canvas>
                <div class="zen-controls">
                     <h3 style="margin-bottom: 1rem; color: var(--dark-color);">جدار التأكيدات</h3>
                     <form id="affirmation-form">
                         <input type="text" id="affirmation-input" placeholder="اكتب تأكيداً إيجابياً..." required style="width: 250px; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
                         <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem; margin-right: 5px;">إرسال</button>
                     </form>
                </div>
                <div class="breathing-guide">
                    <div id="breathing-circle"></div>
                    <p id="breathing-text">شهيق...</p>
                </div>
                <!-- Affirmations will be added here by JS -->
            </section>

            <!-- ==================== دفتر اليوميات الذكي ==================== -->
            <section id="journal-section" class="content-section">
                <div class="container">
                    <h2 class="section-title">يومياتي الذكية</h2>
                    <p class="section-intro">دون أفكارك ومشاعرك هنا. مساحتك خاصة وآمنة تماماً. بعد الحفظ، يمكنك طلب تحليل لطيف من مساعد "طِبرا".</p>
                    <div class="journal-container">
                        <div class="journal-editor">
                            <textarea id="journal-textarea" placeholder="كيف تشعر اليوم؟ ما الذي يدور في ذهنك؟"></textarea>
                            <button id="save-journal-btn" class="btn btn-primary">حفظ الإدخال</button>
                            <button id="analyze-journal-btn" class="btn btn-secondary" style="margin-right: 10px; display: none;">تحليل بواسطة مساعد طِبرا</button>
                            <div id="ai-analysis-result">
                                <p>اضغط على زر التحليل بعد الحفظ لرؤية دعوة للتأمل...</p>
                            </div>
                        </div>
                         <div class="journal-entries">
                             <h3>إدخالات سابقة</h3>
                             <div id="entries-list">
                                 <!-- Journal entries will be listed here -->
                             </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ==================== مُنشئ الأجواء الصوتية ==================== -->
            <section id="soundscape-section" class="content-section">
                <div class="container">
                    <h2 class="section-title">مُنشئ الأجواء الصوتية</h2>
                    <p class="section-intro">اخلط بين الأصوات المختلفة لتصميم جوك الصوتي المثالي للتأمل أو الاسترخاء.</p>
                    <div class="soundscape-mixer">
                        <div class="sound-channel">
                            <label for="rain-slider"><i class="fas fa-cloud-showers-heavy"></i> مطر</label>
                            <input type="range" id="rain-slider" class="sound-slider" min="0" max="1" step="0.01" value="0" data-sound="rain-sound">
                        </div>
                        <div class="sound-channel">
                            <label for="forest-slider"><i class="fas fa-tree"></i> غابة</label>
                            <input type="range" id="forest-slider" class="sound-slider" min="0" max="1" step="0.01" value="0" data-sound="forest-sound">
                        </div>
                        <div class="sound-channel">
                            <label for="waves-slider"><i class="fas fa-water"></i> أمواج</label>
                            <input type="range" id="waves-slider" class="sound-slider" min="0" max="1" step="0.01" value="0" data-sound="waves-sound">
                        </div>
                         <div class="sound-channel">
                            <label for="bowls-slider"><i class="fas fa-om"></i> أوعية غنائية</label>
                            <input type="range" id="bowls-slider" class="sound-slider" min="0" max="1" step="0.01" value="0" data-sound="bowls-sound">
                        </div>
                    </div>
                    <!-- Audio elements (hidden) -->
                    <audio id="rain-sound" src="https://www.soundjay.com/nature/rain-07.mp3" loop></audio>
                    <audio id="forest-sound" src="https://www.soundjay.com/nature/forest-01.mp3" loop></audio>
                    <audio id="waves-sound" src="https://www.soundjay.com/nature/ocean-wave-1.mp3" loop></audio>
                    <audio id="bowls-sound" src="https://cdn.pixabay.com/audio/2022/02/07/audio_8302243211.mp3" loop></audio>
                </div>
            </section>

            <!-- ==================== تجسيد الرحلة الشفائية ==================== -->
            <section id="profile-section" class="content-section">
                <div class="container">
                    <h2 class="section-title">حديقتك الروحية</h2>
                    <p class="section-intro">هذه حديقتك التي تنمو وتزدهر مع كل خطوة تخطوها في رحلتك الشفائية. عد يومياً لسقيها!</p>
                    <div id="lottie-container"></div>
                    <div class="profile-controls" style="margin-top: 2rem;">
                        <button id="water-tree-btn" class="btn btn-primary"><i class="fas fa-tint"></i> اسقِ شجرتك اليوم</button>
                        <button id="share-garden-btn" class="btn btn-secondary" style="margin-right: 10px;"><i class="fas fa-share-alt"></i> شارك حديقتك</button>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item"><span id="meditations-stat">0</span> تأملات مكتملة</div>
                        <div class="stat-item"><span id="journal-stat">0</span> إدخالات يومية</div>
                        <div class="stat-item"><span id="streak-stat">0</span> أيام متتالية</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ==================== JavaScript Code ==================== -->
    <script type="module">
        // ==== استيراد الدوال من مكتبات Firebase ====
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // =========================================================================================
        //
        //      هذا هو كود الربط الخاص بك. لقد تم وضعه هنا.
        //
        const firebaseConfig = {
            apiKey: "AIzaSyBi2y64T-X1FNwbhv8ATQnF5xTZ3Pq4neg",
            authDomain: "tibrasoul.firebaseapp.com",
            projectId: "tibrasoul",
            storageBucket: "tibrasoul.appspot.com", // تم تصحيح هذا
            messagingSenderId: "920755760709",
            appId: "1:920755760709:web:778cd12e6edbd199827d2c"
        };
        //
        // =========================================================================================

        // ==== تهيئة Firebase والتوابع ====
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // ==== متغيرات عامة وعناصر DOM ====
        let currentUser = null;
        let lottieAnimation = null;
        let lastJournalEntry = "";
        const loginScreen = document.getElementById('login-screen');
        const mainAppContent = document.getElementById('main-app-content');
        const appLoader = document.getElementById('app-loader');

        // ==== 1. نظام المصادقة (Authentication) ====
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        googleLoginBtn.addEventListener('click', () => {
            appLoader.style.display = 'block';
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Auth Error:", error);
                    alert("حدث خطأ أثناء تسجيل الدخول: " + error.message);
                    appLoader.style.display = 'none';
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error("Sign out error", error));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginScreen.style.display = 'none';
                mainAppContent.style.display = 'block';
                appLoader.style.display = 'none';
                setupUIForUser(user);
                initializeAllFeatures();
            } else {
                currentUser = null;
                loginScreen.style.display = 'block';
                mainAppContent.style.display = 'none';
            }
        });

        function setupUIForUser(user) {
            document.getElementById('user-name').textContent = user.displayName;
            document.getElementById('user-profile-img').src = user.photoURL;
        }

        // ==== 2. الحديقة الرقمية التفاعلية (Digital Zen Garden) ====
        function initializeZenGarden() {
            const canvas = document.getElementById('zen-garden-canvas');
            const zenSection = document.getElementById('zen-garden-section');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            function resizeCanvas() {
                canvas.width = zenSection.offsetWidth;
                canvas.height = zenSection.offsetHeight;
                // Draw background
                ctx.fillStyle = '#E6DBC9';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#D8C7B2';
                for(let i = 0; i < canvas.height; i += 2) {
                    ctx.fillRect(0, i, canvas.width, 1);
                }
            }
            
            resizeCanvas();

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;

                ctx.strokeStyle = 'rgba(0, 0, 0, 0.04)';
                ctx.lineWidth = 40;
                ctx.lineCap = 'round';
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            canvas.addEventListener('mousedown', (e) => { isDrawing = true; draw(e); });
            canvas.addEventListener('touchstart', (e) => { isDrawing = true; draw(e); });
            canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });
            canvas.addEventListener('touchend', () => { isDrawing = false; ctx.beginPath(); });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchmove', draw);
            window.addEventListener('resize', resizeCanvas);

            // Breathing Guide
            const breathingText = document.getElementById('breathing-text');
            setInterval(() => {
                if (breathingText.textContent === 'شهيق...') {
                    breathingText.textContent = 'زفير...';
                } else {
                    breathingText.textContent = 'شهيق...';
                }
            }, 4000);

            // Affirmations Wall
            const affirmationForm = document.getElementById('affirmation-form');
            affirmationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('affirmation-input');
                const text = input.value;
                if(text.trim() === '') return;

                try {
                    await addDoc(collection(db, "affirmations"), {
                        text: text,
                        createdAt: serverTimestamp()
                    });
                    input.value = '';
                } catch (error) {
                    console.error("Error adding affirmation: ", error);
                }
            });
            
            const q = query(collection(db, "affirmations"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        createFloatingAffirmation(change.doc.data().text);
                    }
                });
            });
        }
        
        function createFloatingAffirmation(text) {
            const affirmationEl = document.createElement('div');
            affirmationEl.classList.add('affirmation');
            affirmationEl.textContent = text;
            affirmationEl.style.top = `${Math.random() * 80 + 10}%`; // from 10% to 90%
            affirmationEl.style.animationDuration = `${Math.random() * 20 + 20}s`; // 20 to 40 seconds
            document.getElementById('zen-garden-section').appendChild(affirmationEl);
            setTimeout(() => {
                affirmationEl.remove();
            }, 40000);
        }

        // ==== 3. دفتر اليوميات الذكي (AI Journal) ====
        function initializeJournal() {
            const saveBtn = document.getElementById('save-journal-btn');
            const analyzeBtn = document.getElementById('analyze-journal-btn');
            const textarea = document.getElementById('journal-textarea');
            const analysisResult = document.getElementById('ai-analysis-result');
            
            saveBtn.addEventListener('click', async () => {
                const entryText = textarea.value;
                if(entryText.trim() === '' || !currentUser) return;
                
                try {
                    await setDoc(doc(db, `users/${currentUser.uid}/journal/${new Date().toISOString()}`), {
                        text: entryText,
                        createdAt: serverTimestamp()
                    });
                    alert("تم حفظ الإدخال بنجاح!");
                    lastJournalEntry = entryText;
                    textarea.value = '';
                    analyzeBtn.style.display = 'inline-block';
                    analysisResult.innerHTML = '<p>يمكنك الآن تحليل هذا الإدخال.</p>';
                } catch (error) {
                    console.error("Error saving journal entry: ", error);
                    alert("حدث خطأ أثناء الحفظ.");
                }
            });

            analyzeBtn.addEventListener('click', async () => {
                if(lastJournalEntry === '') return;
                analysisResult.innerHTML = '<p>جاري التحليل بواسطة مساعد طِبرا...</p>';
                
                // --- Gemini API Call ---
                const GEMINI_API_KEY = ""; // TODO: ضع مفتاح Gemini API هنا
                if (!GEMINI_API_KEY) {
                    analysisResult.innerHTML = '<p>عذراً، ميزة التحليل الذكي غير مفعلة. يتطلب الأمر مفتاح Gemini API.</p>';
                    return;
                }
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                
                const prompt = `أنت مساعد لطيف وغير إكلينيكي اسمه "طِبرا". قم بتحليل نص اليوميات التالي وقدم دعوة قصيرة للتأمل أو ملاحظة إيجابية بناءً عليه. ركز على الأنماط العاطفية أو الكلمات المتكررة. اجعل الرد قصيراً وداعماً باللغة العربية. النص هو: "${lastJournalEntry}"`;
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    const analysisText = data.candidates[0].content.parts[0].text;
                    analysisResult.innerHTML = `<p>${analysisText}</p>`;
                    
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    analysisResult.innerHTML = '<p>عذراً، لم أتمكن من إتمام التحليل الآن. يرجى المحاولة لاحقاً.</p>';
                }
            });
        }

        // ==== 4. مُنشئ الأجواء الصوتية (Soundscape Mixer) ====
        function initializeSoundscape() {
            const sliders = document.querySelectorAll('.sound-slider');
            let audioContext;
            const audioElements = document.querySelectorAll('audio');

            let allAudioReady = false;

            function playAllAudio() {
                if(allAudioReady) return;
                audioElements.forEach(audio => {
                    audio.play().catch(e => console.log(`Audio ${audio.id} failed to play initially.`));
                });
                allAudioReady = true;
            }
            // Add a single event listener to the document to play audio on first user interaction
            document.body.addEventListener('click', playAllAudio, { once: true });
            document.body.addEventListener('touchstart', playAllAudio, { once: true });


            sliders.forEach(slider => {
                const audioEl = document.getElementById(slider.dataset.sound);
                if(audioEl) {
                    slider.addEventListener('input', () => {
                        audioEl.volume = slider.value;
                    });
                }
            });
        }
        
        // ==== 5. تجسيد الرحلة الشفائية (Visual Journey Profile) ====
        function initializeProfile() {
            const lottieContainer = document.getElementById('lottie-container');
            const waterBtn = document.getElementById('water-tree-btn');
            const shareBtn = document.getElementById('share-garden-btn');

            lottieAnimation = lottie.loadAnimation({
                container: lottieContainer,
                renderer: 'svg',
                loop: false,
                autoplay: false,
                path: 'https://lottie.host/e8c8135e-c020-4286-a2b9-2917e7502758/Zq2I46ZlXU.json'
            });

            waterBtn.addEventListener('click', () => {
                alert("تم سقي حديقتك. شكراً لاهتمامك اليومي!");
                // Here you would typically update user data in Firestore
            });

            shareBtn.addEventListener('click', () => {
                const profileSection = document.getElementById('profile-section');
                html2canvas(profileSection).then(canvas => {
                    const image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                    const link = document.createElement('a');
                    link.download = 'hadikati-alrohia.png';
                    link.href = image;
                    link.click();
                });
            });
        }

        // ==== دالة التشغيل الرئيسية ====
        function initializeAllFeatures() {
            if (!currentUser) return;
            initializeZenGarden();
            initializeJournal();
            initializeSoundscape();
            initializeProfile();
        }
    </script>
</body>
</html>
```

لقد قمت بإضافة الكود الخاص بك وتصحيح `storageBucket`. أصبح الملف الآن جاهزاً بشكل كامل. فقط قم بنسخه ونشره على GitHub. بالتوف