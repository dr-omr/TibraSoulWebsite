<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="د. عمر العماد - رحلتك نحو الشفاء بالطب الشمولي والوظيفي. أدوات ذكية، جلسات علاجية، ومنتجات طبيعية.">
    <meta name="keywords" content="طب شمولي, طب وظيفي, علاج عن بعد, منتجات طبيعية, شفاء, دكتور عمر العماد, طِبرا, عجلة الحياة, تقييم صحي, DMSO, ترددات شفائية, تشخيص ذكي, خطة علاجية">
    <title>د. عمر العماد | خبير الطب الشمولي والوظيفي</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- GLOBAL DESIGN SYSTEM & VARIABLES --- */
        :root {
            --primary-color: #5a6e5a;
            --primary-dark: #435243;
            --secondary-color: #f4f1eb;
            --accent-color: #c8a07d;
            --accent-light: #e6d3c1;
            --text-dark: #333333;
            --text-light: #f8f9fa;
        }
        
        /* --- GENERAL BODY & TYPOGRAPHY STYLES --- */
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-dark);
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Kufi Arabic', sans-serif; /* Keep consistent font for headers */
            font-weight: 700;
        }
        .font-brand {
            font-family: 'Great Vibes', cursive;
        }

        /* --- ADVANCED ANIMATIONS & EFFECTS --- */
        @keyframes subtle-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }
        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--accent-light); }
            50% { box-shadow: 0 0 20px var(--accent-light); }
            100% { box-shadow: 0 0 5px var(--accent-light); }
        }
        @keyframes pulse-loader {
          0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(90, 110, 90, 0.7); }
          70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(90, 110, 90, 0); }
          100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(90, 110, 90, 0); }
        }

        /* --- HERO SECTION STYLES --- */
        .hero-bg { animation: subtle-pan 25s ease-in-out infinite; }
        .hero-gradient { background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0.2)); }

        /* --- ENHANCED BUTTON STYLES --- */
        .btn { position: relative; overflow: hidden; transition: all 0.3s ease; transform-style: preserve-3d; }
        .btn-primary { background-color: var(--primary-color); color: var(--text-light); }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-4px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-secondary:hover { background-color: var(--primary-color); color: var(--text-light); transform: translateY(-4px); box-shadow: 0 8px 15px rgba(90, 110, 90, 0.2); }
        .btn-glow { animation: glow 3s infinite ease-in-out; }
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple-effect 0.6s linear; background-color: rgba(255, 255, 255, 0.5); }
        
        /* --- INTERACTIVE DASHBOARD CARD --- */
        .dashboard-card { cursor: pointer; transition: transform 0.4s ease, box-shadow 0.4s ease; transform-style: preserve-3d; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }

        /* --- SECTION STYLES --- */
        .section-title::after { content: ''; display: block; width: 60px; height: 3px; background-color: var(--accent-color); margin: 1rem auto 0; transition: width 0.5s ease; }
        .section-title:hover::after { width: 100px; }
        
        /* --- WHATSAPP & MODAL --- */
        .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 40px; left: 40px; background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 100; transition: transform 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .whatsapp-float:hover { transform: scale(1.1) rotate(10deg); }
        #tool-modal { transition: opacity 0.3s ease, backdrop-filter 0.3s ease; backdrop-filter: blur(0px); }
        #tool-modal.is-open { opacity: 1; backdrop-filter: blur(8px); }

        /* --- FADE-IN ANIMATION --- */
        .fade-in-up { opacity: 0; transform: translateY(40px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
        .fade-in-up.is-visible { opacity: 1; transform: translateY(0); }
        
        /* --- AI LOADER --- */
        .ai-loader .ai-loader-dots div { background-color: var(--primary-color); animation: pulse-loader 1.4s infinite ease-in-out both; }
        .ai-loader .ai-loader-dots .dot1 { animation-delay: -0.32s; }
        .ai-loader .ai-loader-dots .dot2 { animation-delay: -0.16s; }

        /* --- FREQUENCY GENERATOR STYLES --- */
        #frequency-canvas { background-color: #1a1a1a; border-radius: 8px; box-shadow: inset 0 0 10px #000; }
        .freq-btn.active { background-color: var(--accent-color); color: white; transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }

        /* --- SINGLE POST STYLES --- */
        #view-single-post .post-content h2 { font-size: 1.75rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; }
        #view-single-post .post-content p { font-size: 1.1rem; line-height: 1.8; margin-bottom: 1.5rem; }
        #view-single-post .post-content ul { list-style-type: disc; margin-right: 2rem; margin-bottom: 1.5rem; }
        #view-single-post .post-content li { margin-bottom: 0.5rem; }

        /* --- WHEEL OF LIFE (NEW) --- */
        #wheel-of-life-result { transition: opacity 0.5s ease-in-out; }
        #wheel-of-life-result-container .range-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; border-radius: 4px;
            background: var(--accent-light); outline: none; transition: opacity .2s;
        }
        #wheel-of-life-result-container .range-slider::-webkit-slider-thumb {
             -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
             border-radius: 50%; background: var(--primary-color); cursor: pointer;
        }

        /* --- AUDIO PLAYER (NEW) --- */
        .audio-player { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.1); }
        #audio-progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; background: var(--accent-light); outline: none; transition: opacity .2s; }
        #audio-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; }
    </style>
</head>
<body class="bg-secondary-color text-text-dark">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-lg sticky top-0 z-50 transition-shadow duration-300">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="font-brand text-4xl text-gray-800 nav-link" data-view="hero">د. عمر العماد</a>
            <div class="hidden md:flex items-center space-x-reverse space-x-6">
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="about">عني</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="dashboard">الخدمات التفاعلية</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="wheel-of-life">تقييم العافية</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="services">الجلسات</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="store">المتجر</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="blog">المدونة</a>
                 <!-- Login/Profile Link -->
                 <div id="auth-section" class="flex items-center">
                     <button id="login-btn" class="font-bold text-[--primary-color] hover:underline">تسجيل الدخول</button>
                     <div id="profile-section-nav" class="hidden items-center">
                         <a href="#" class="nav-link font-bold text-[--primary-color] hover:underline ml-4" data-view="premium-content">ملف المريض</a>
                         <img id="user-avatar" class="w-8 h-8 rounded-full" alt="صورة المستخدم" onerror="this.src='https://placehold.co/40x40/5a6e5a/white?text=U'">
                     </div>
                 </div>
            </div>
            <a href="#contact" class="hidden md:block btn btn-primary text-white py-2 px-6 rounded-full">احجز جلستك</a>
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </nav>
         <!-- Mobile Menu -->
         <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
              <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="about">عني</a>
              <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="dashboard">الخدمات التفاعلية</a>
              <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="wheel-of-life">تقييم العافية</a>
              <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="services">الجلسات</a>
              <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="store">المتجر</a>
              <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="blog">المدونة</a>
              <a href="#contact" class="block py-2 hover:text-[--primary-color]">تواصل معي</a>
              <hr class="my-2">
              <div id="auth-section-mobile">
                  <button id="login-btn-mobile" class="w-full text-right py-2 font-bold text-[--primary-color]">تسجيل الدخول</button>
                  <a href="#" id="profile-link-mobile" class="nav-link hidden w-full text-right py-2 font-bold text-[--primary-color]" data-view="premium-content">ملف المريض</a>
              </div>
         </div>
    </header>

    <main id="main-content">
        <!-- Hero Section -->
        <section id="view-hero" class="page-view relative h-screen flex items-center justify-center text-white text-center">
            <div class="absolute inset-0 bg-cover bg-center hero-bg" style="background-image: url('https://images.unsplash.com/photo-1542601906-8b6aBA801697?q=80&w=2070&auto=format&fit=crop');"></div>
            <div class="absolute inset-0 hero-gradient"></div>
            <div class="relative z-10 p-6 fade-in-up">
                <h1 class="font-brand text-7xl md:text-9xl mb-4">ṬibraSoul</h1>
                <h2 class="text-2xl md:text-4xl font-bold mb-2">رحلتك نحو الشفاء المتكامل تبدأ هنا</h2>
                <p class="text-lg md:text-xl max-w-3xl mx-auto">أساعدك على استعادة توازن جسدك وروحك عبر دمج حكمة الطب الشمولي والوظيفي مع أحدث العلوم.</p>
                <a href="#" class="nav-link mt-8 inline-block btn bg-white text-[--primary-color] font-bold py-3 px-8 rounded-full text-lg btn-glow" data-view="dashboard">اكتشف خدماتنا</a>
            </div>
        </section>

        <!-- Interactive Dashboard Section -->
        <section id="view-dashboard" class="page-view py-20 bg-gray-50 hidden">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 section-title">لوحة التحكم التفاعلية</h2>
                <p class="max-w-3xl mx-auto mb-12">اختر الأداة أو الخدمة التي تناسب احتياجك الحالي وابدأ رحلة الشفاء.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Cards from original code -->
                    <div class="p-8 rounded-xl shadow-lg dashboard-card text-center">
                        <div class="text-5xl text-[--primary-color] mb-4"><i class="fas fa-magic-wand-sparkles"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الأدوات الذكية</h3>
                        <p class="text-gray-600 mb-6">استخدم أدوات الذكاء الاصطناعي للتشخيص، إنشاء الخطط العلاجية، الحصول على توصيات، والمزيد.</p>
                        <div class="grid grid-cols-2 gap-3">
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="diagnosis">التشخيص</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="treatment-plan">خطة علاجية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="supplements">توصية مكملات</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="awareness-exercise">تمرين وعي</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="consultation">استشارة آلية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="intention">نية اليوم</button>
                        </div>
                    </div>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="services">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-user-doctor"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الجلسات الاستشارية</h3>
                        <p class="text-gray-600">احجز جلسة استشارية شاملة أو جلسة متابعة معي مباشرة لوضع خريطة طريق علاجية مخصصة.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="frequencies">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-wave-square"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الترددات الشفائية</h3>
                        <p class="text-gray-600">استمع إلى ترددات السولفيجيو المصممة لتهدئة الجهاز العصبي وتحفيز الشفاء أثناء التأمل.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="store">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-store"></i></div>
                        <h3 class="text-2xl font-bold mb-3">المتجر العلاجي</h3>
                        <p class="text-gray-600">تصفح مجموعتنا المنتقاة من المكملات الغذائية والمنتجات الطبيعية التي أوصي بها.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="blog">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-book-open"></i></div>
                        <h3 class="text-2xl font-bold mb-3">المقالات والمعرفة</h3>
                        <p class="text-gray-600">اقرأ أحدث المقالات والرؤى حول الطب الشمولي، التغذية، والصحة النفسية لتعميق فهمك.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="premium-content">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-folder-user"></i></div>
                        <h3 class="text-2xl font-bold mb-3">ملف المريض</h3>
                        <p class="text-gray-600">ادخل إلى مساحتك الخاصة لمراجعة نتائجك المحفوظة والمحتوى الحصري للأعضاء (يتطلب تسجيل الدخول).</p>
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Wheel of Life Section (NEW) -->
        <section id="view-wheel-of-life" class="page-view py-20 bg-white hidden">
            <div class="container mx-auto px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold mb-4 section-title">عجلة العافية الشمولية</h2>
                    <p class="max-w-3xl mx-auto text-lg">قيّم مستوى رضاك في الجوانب الأساسية لحياتك. حرك المؤشرات لتعكس وضعك الحالي، ثم احصل على رؤى فورية لمساعدتك على تحديد نقاط التركيز في رحلتك نحو التوازن.</p>
                </div>

                <div id="wheel-of-life-result-container" class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <!-- Chart Canvas -->
                    <div class="w-full max-w-lg mx-auto fade-in-up">
                        <canvas id="wheel-of-life-chart"></canvas>
                    </div>
                    <!-- Sliders -->
                    <div id="wheel-of-life-sliders" class="space-y-4 fade-in-up" style="animation-delay: 0.2s;">
                        <!-- Sliders will be dynamically generated here -->
                    </div>
                </div>

                <!-- Result Section -->
                <div class="mt-12 text-center">
                     <button id="get-wheel-insight-btn" class="btn btn-primary text-white py-3 px-8 text-lg rounded-full">اكشف عن رؤيتك الشخصية</button>
                     <div id="wheel-of-life-result" class="mt-6 p-6 bg-green-50 border-r-4 border-primary-color rounded-lg max-w-4xl mx-auto opacity-0 hidden">
                        <!-- AI Insight will be injected here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- About Me Section -->
        <section id="view-about" class="page-view py-20 bg-white hidden">
             <!-- Content from original code -->
             <div class="container mx-auto px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="md:flex items-center gap-12">
                    <div class="md:w-1/3 text-center fade-in-up">
                        <img src="https://i.ibb.co/6wmT73L/image-c28027.jpg" alt="صورة د. عمر العماد" class="rounded-full shadow-2xl mx-auto w-64 h-64 md:w-80 md:h-80 object-cover border-4 border-white" onerror="this.onerror=null;this.src='https://placehold.co/320x320/eeeeee/333333?text=Dr.+Omar';">
                    </div>
                    <div class="md:w-2/3 mt-8 md:mt-0 fade-in-up">
                        <h2 class="text-4xl font-bold mb-4 section-title text-right">عن د. عمر العماد</h2>
                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-4">طبيبك ومرشدك في رحلة الشفاء</h3>
                        <p class="mb-4">أنا طبيب متخصص في الطب الشمولي والوظيفي، أؤمن بأن الشفاء الحقيقي ينبع من معالجة الأسباب الجذرية للمرض، وليس فقط أعراضه. من خلال خبرتي، أجمع بين الطب الحديث، التغذية العلاجية، وتقنيات إدارة الضغط النفسي لمساعدتك على تحقيق صحة مثالية.</p>
                        <p class="font-semibold">هدفي هو تمكينك بالمعرفة والأدوات اللازمة لتصبح أنت طبيب نفسك، وتعيش حياة مليئة بالحيوية والسكينة.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section id="view-services" class="page-view py-20 hidden">
             <!-- Content from original code -->
             <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">جلسات العلاج الشمولي</h2>
                <p class="max-w-2xl mx-auto mb-12">جلسات شخصية عن بعد، مصممة خصيصاً لتلبية احتياجاتك الفريدة ومساعدتك على تحقيق أهدافك الصحية.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-user-md"></i></div>
                        <h3 class="text-2xl font-bold mb-3">استشارة أولية شاملة</h3>
                        <p class="mb-6">جلسة لمدة 90 دقيقة لتقييم حالتك الصحية بالكامل، مناقشة تاريخك المرضي، ووضع خريطة طريق علاجية مخصصة.</p>
                        <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20أولية%20شاملة" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">احجز الآن</a>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-heartbeat"></i></div>
                        <h3 class="text-2xl font-bold mb-3">باقة المتابعة الصحية</h3>
                        <p class="mb-6">3 جلسات متابعة (45 دقيقة لكل جلسة) لمراقبة تقدمك، تعديل الخطة العلاجية، وتقديم الدعم المستمر لك.</p>
                         <a href="https://wa.me/967771447111?text=أرغب%20في%20الاشتراك%20بباقة%20المتابعة%20الصحية" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">اشترك الآن</a>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.4s;">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-leaf"></i></div>
                        <h3 class="text-2xl font-bold mb-3">استشارة التغذية الوظيفية</h3>
                        <p class="mb-6">جلسة مركزة لمدة 60 دقيقة لوضع خطة تغذية علاجية مخصصة لمعالجة مشاكل صحية معينة مثل مشاكل الهضم أو الطاقة.</p>
                         <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20التغذية%20الوظيفية" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">احجز الآن</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Store Section -->
        <section id="view-store" class="page-view py-20 bg-gray-50 hidden">
            <!-- Content from original code -->
            <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">متجر المنتجات الشافية</h2>
                <p class="max-w-2xl mx-auto mb-12">مجموعة منتقاة بعناية من المنتجات الطبيعية والأدوية الوظيفية التي أثق بها وأوصي بها لدعم رحلتك العلاجية.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                     <!-- Product 1 -->
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <img src="https://placehold.co/300x300/5a6e5a/white?text=DMSO" alt="DMSO" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">DMSO للجلد</h3>
                            <p class="text-gray-600 mb-4">مذيب طبيعي قوي لدعم الشفاء وتخفيف الألم الموضعي.</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">$45</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20DMSO%20للجلد" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <!-- Product 2 -->
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.1s;">
                        <img src="https://placehold.co/300x300/c8a07d/white?text=Vit+D3" alt="مكمل فيتامين د3 + ك2" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">مكمل فيتامين د3 + ك2</h3>
                            <p class="text-gray-600 mb-4">لدعم صحة العظام والمناعة.</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">$35</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20مكمل%20فيتامين%20د3%20%2B%20ك2" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <!-- Product 3 -->
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <img src="https://placehold.co/300x300/5a6e5a/white?text=Mg+Oil" alt="زيت الماغنسيوم النقي" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">زيت الماغنسيوم النقي</h3>
                            <p class="text-gray-600 mb-4">للاسترخاء وتخفيف آلام العضلات.</p>
                             <p class="text-2xl font-bold text-[--primary-color] mb-4">$25</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20زيت%20الماغنسيوم%20النقي" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                     <!-- Product 4 -->
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.3s;">
                        <img src="https://placehold.co/300x300/c8a07d/white?text=Probiotic" alt="بروبيوتيك عالي الجودة" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">بروبيوتيك عالي الجودة</h3>
                            <p class="text-gray-600 mb-4">لدعم صحة الجهاز الهضمي والميكروبيوم.</p>
                             <p class="text-2xl font-bold text-[--primary-color] mb-4">$50</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20بروبيوتيك%20عالي%20الجودة" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Frequency Generator Section -->
        <section id="view-frequencies" class="page-view py-20 bg-white hidden">
            <!-- Content from original code -->
            <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">مولد الترددات الشفائية</h2>
                <p class="max-w-2xl mx-auto mb-12">اختر أحد ترددات السولفيجيو للاستماع إليها أثناء التأمل. استخدم سماعات الرأس لأفضل تأثير.</p>
                <div class="bg-gray-100 p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <canvas id="frequency-canvas" class="w-full h-32 mb-8"></canvas>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="frequency-buttons">
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="396">396 Hz - تحرير الذنب والخوف</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="417">417 Hz - تسهيل التغيير</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="528">528 Hz - التحول والمعجزات</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="639">639 Hz - إعادة الاتصال والعلاقات</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="741">741 Hz - إيقاظ الحدس</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="852">852 Hz - العودة إلى النظام الروحي</button>
                    </div>
                    <button id="stop-freq-btn" class="mt-8 btn btn-secondary py-2 px-6 rounded-full hidden">إيقاف التردد</button>
                </div>
            </div>
        </section>
        
        <!-- Premium Content / Patient File Section -->
        <section id="view-premium-content" class="page-view py-20 hidden">
            <!-- Content from original code -->
            <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 id="welcome-message" class="text-4xl font-bold mb-4 section-title">مرحباً بك في أسرتنا</h2>
                <p class="max-w-2xl mx-auto mb-12">هذه مساحتك الحصرية. هنا ستجد المحتوى الخاص وجميع نتائجك المحفوظة من أدواتنا الذكية.</p>
                <div id="patient-file-content" class="bg-white p-8 rounded-xl shadow-inner max-w-4xl mx-auto text-right">
                    <h3 class="text-2xl font-bold mb-6">سجلاتي المحفوظة</h3>
                    <div id="saved-results-container" class="space-y-6">
                        <!-- Saved results will be loaded here -->
                        <p>الرجاء تسجيل الدخول لعرض سجلاتك المحفوظة.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Blog Section -->
        <section id="view-blog" class="page-view py-20 bg-gray-50 hidden">
             <!-- Content from original code -->
             <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">من وحي المدونة</h2>
                <p class="max-w-2xl mx-auto mb-12">مقالات ورؤى لمساعدتك على فهم جسدك بشكل أفضل واتخاذ قرارات صحية مستنيرة.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 text-right">
                    <!-- Article 1 -->
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <img src="https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070&auto=format&fit=crop" alt="صورة طعام صحي" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-3">هل أمعاؤك هي سبب تقلبات مزاجك؟</h3>
                            <p class="text-gray-600 mb-4">اكتشف العلاقة المدهشة بين صحة الجهاز الهضمي وصحتك النفسية.</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="gut-brain">اقرأ المزيد &larr;</a>
                        </div>
                    </div>
                    <!-- Article 2 -->
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <img src="https://images.unsplash.com/photo-1599301934984-1d2741913a5f?q=80&w=2070&auto=format&fit=crop" alt="صورة امرأة تتأمل" class="w-full h-56 object-cover">
                        <div class="p-6">
                             <h3 class="text-xl font-bold mb-3">قوة التنفس: كيف تهدئ جهازك العصبي في 5 دقائق</h3>
                            <p class="text-gray-600 mb-4">تعلم تقنية تنفس بسيطة وفعالة لخفض التوتر والقلق فوراً.</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="breathing">اقرأ المزيد &larr;</a>
                        </div>
                    </div>
                    <!-- Article 3 -->
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.4s;">
                        <img src="https://images.unsplash.com/photo-1476837579993-f1d3948f17c2?q=80&w=2070&auto=format&fit=crop" alt="صورة توابل وأعشاب" class="w-full h-56 object-cover">
                        <div class="p-6">
                           <h3 class="text-xl font-bold mb-3">أفضل 3 مكملات غذائية لمكافحة الالتهابات</h3>
                            <p class="text-gray-600 mb-4">دليلي لاختيار المكملات الأكثر فعالية لدعم صحتك العامة.</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="supplements">اقرأ المزيد &larr;</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Single Post View -->
        <section id="view-single-post" class="page-view py-20 bg-white hidden">
            <!-- Content from original code -->
            <div class="container mx-auto px-6 max-w-4xl">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="blog">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى المدونة
                     </button>
                 </div>
                 <article>
                     <h1 id="post-title" class="text-4xl md:text-5xl font-bold mb-4 text-center section-title"></h1>
                     <img id="post-image" src="" alt="صورة المقال" class="w-full h-96 object-cover rounded-xl shadow-lg my-8">
                     <div id="post-content" class="prose lg:prose-xl max-w-none text-right">
                         <!-- Article content will be injected here -->
                     </div>
                 </article>
            </div>
        </section>
        
        <!-- Mindfulness Moment Section (NEW) -->
        <section class="py-20 bg-gray-50">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 section-title">لحظة هدوء</h2>
                <p class="max-w-2xl mx-auto mb-8 text-lg">خذ دقيقة من يومك لإعادة شحن طاقتك وتهدئة جهازك العصبي مع هذا التمرين التنفسي الموجه.</p>
                <div class="max-w-md mx-auto fade-in-up">
                    <div class="audio-player">
                         <div class="flex items-center">
                             <button id="audio-play-pause-btn" class="text-4xl text-[--primary-color] hover:text-[--primary-dark] transition-colors">
                                 <i class="fas fa-play-circle"></i>
                             </button>
                             <div class="flex-grow mx-4 text-right">
                                 <div class="font-bold text-lg text-text-dark">تمرين التنفس العميق</div>
                                 <div id="audio-time" class="text-sm text-gray-600">00:00 / 01:00</div>
                                 <input type="range" id="audio-progress-bar" value="0" step="1" class="w-full mt-2">
                             </div>
                         </div>
                    </div>
                    <audio id="guided-audio" src="https://firebasestorage.googleapis.com/v0/b/tibrasoul.appspot.com/o/audio%2F1-minute-breathing-meditation.mp3?alt=media&token=48734898-1e43-4158-b7a4-9dfc120336b1"></audio>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Footer -->
    <footer id="contact" class="bg-gray-800 text-white pt-20 pb-8">
        <!-- Content from original code -->
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-4">هل أنت مستعد لبدء رحلة الشفاء؟</h2>
            <p class="max-w-xl mx-auto mb-8">تواصل معي اليوم عبر واتساب لحجز استشارتك الأولى، أو تابعني على وسائل التواصل الاجتماعي لمحتوى يومي ملهم.</p>
            <a href="https://wa.me/967771447111?text=أهلاً%20د.%20عمر،%20أرغب%20في%20الاستفسار%20عن%20جلسات%20العلاج%20الشمولي" target="_blank" class="btn btn-primary text-white text-xl py-3 px-8 rounded-full inline-block mb-12"><i class="fab fa-whatsapp"></i> تواصل معي عبر واتساب</a>
            
            <div class="flex justify-center space-x-6 text-3xl mb-8">
                <a href="https://www.instagram.com/dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.tiktok.com/@dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-tiktok"></i></a>
            </div>

            <div class="border-t border-gray-700 pt-6">
                 <p>&copy; 2025 د. عمر العماد | جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/967771447111" class="whatsapp-float" target="_blank" aria-label="تواصل معنا عبر واتساب">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Tool Modal -->
    <div id="tool-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 opacity-0">
        <div id="modal-content" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="hidden fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-transform duration-500 translate-x-full">
        <p id="notification-message" class="text-white"></p>
    </div>
    
    <script type="module">
        // --- SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
             apiKey: "AIzaSyBi2y64T-X1FNwbhv8ATQnF5xTZ3Pq4neg",
             authDomain: "tibrasoul.firebaseapp.com",
             projectId: "tibrasoul",
             storageBucket: "tibrasoul.appspot.com",
             messagingSenderId: "920755760709",
             appId: "1:920755760709:web:778cd12e6edbd199827d2c"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let wheelChart; // New state for chart instance

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            initSmartTools();
            initFrequencyGenerator();
            initGeneralUI();
            initNavigation();
            initCreativeEffects();
            initBlog();
            initWheelOfLife(); // NEW
            initAudioPlayer(); // NEW
            showView('hero');
        });

        // --- NAVIGATION MODULE ---
        function initNavigation() {
            // Unchanged from original code
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.dataset.view;
                    if (viewName) {
                        showView(viewName);
                    }
                });
            });
        }

        function showView(viewId) {
            // Unchanged from original code
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.add('hidden');
            });
            const targetView = document.getElementById('view-' + viewId);
            if(targetView) {
                targetView.classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        }

        // --- NOTIFICATION MODULE ---
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        let notificationTimeout;
        function showNotification(message, type = 'error', duration = 4000) {
            // Unchanged from original code
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            notificationToast.className = 'fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-all duration-500 transform text-white';
            if (type === 'success') {
                notificationToast.classList.add('bg-green-500');
            } else if (type === 'warning') {
                notificationToast.classList.add('bg-yellow-500');
            } else {
                notificationToast.classList.add('bg-red-600');
            }
            notificationToast.classList.remove('hidden');
            setTimeout(() => {
                notificationToast.classList.remove('translate-x-full');
            }, 10);
            notificationTimeout = setTimeout(() => {
                notificationToast.classList.add('translate-x-full');
                 setTimeout(() => notificationToast.classList.add('hidden'), 500);
            }, duration);
        }

        // --- AUTHENTICATION MODULE ---
        function initAuth() {
            // Unchanged from original code
            const loginBtns = [document.getElementById('login-btn'), document.getElementById('login-btn-mobile')];
            const profileNav = document.getElementById('profile-section-nav');
            const profileLinkMobile = document.getElementById('profile-link-mobile');
            const userAvatar = document.getElementById('user-avatar');
            const welcomeMessage = document.getElementById('welcome-message');

            onAuthStateChanged(auth, user => {
                currentUser = user;
                const isLoggedIn = !!user;
                
                loginBtns.forEach(btn => btn.classList.toggle('hidden', isLoggedIn));
                profileNav.classList.toggle('hidden', !isLoggedIn);
                profileNav.classList.toggle('flex', isLoggedIn);
                profileLinkMobile.classList.toggle('hidden', !isLoggedIn);
                
                if (isLoggedIn) {
                    if (userAvatar) userAvatar.src = user.photoURL || 'https://placehold.co/40x40/5a6e5a/white?text=U';
                    if (welcomeMessage) welcomeMessage.textContent = `مرحباً بك في أسرتنا، ${user.displayName || 'صديقي'}`;
                    loadPatientFileData();
                } else {
                     document.getElementById('saved-results-container').innerHTML = '<p>الرجاء تسجيل الدخول لعرض سجلاتك المحفوظة.</p>';
                }
            });

            const handleLogin = () => {
                signInWithPopup(auth, provider).catch(error => {
                    console.error("Google Login Error:", error);
                    if (error.code === 'auth/operation-not-allowed') {
                         showNotification("فشل تسجيل الدخول. يجب تفعيل Google كطريقة تسجيل دخول في مشروع Firebase.", "error");
                    } else {
                        showNotification("فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.", "error");
                    }
                });
            }
            loginBtns.forEach(btn => btn.addEventListener('click', handleLogin));
        }
        
        // --- PATIENT FILE & FIRESTORE MODULE ---
        async function saveResultToFirestore(toolName, resultData) {
            // Unchanged from original code
            if (!currentUser) {
                showNotification('الرجاء تسجيل الدخول لحفظ نتائجك.', 'warning'); 
                return;
            }
            const resultId = `${toolName.replace(/\s+/g, '-')}-${new Date().getTime()}`;
            const resultRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'toolResults', resultId);
            
            try {
                await setDoc(resultRef, {
                    tool: toolName,
                    data: resultData,
                    createdAt: new Date()
                });
                const saveBtn = document.getElementById('save-result-btn') || document.getElementById('save-wheel-result-btn');
                if(saveBtn) {
                   saveBtn.textContent = 'تم الحفظ بنجاح!';
                   saveBtn.disabled = true;
                }
                showNotification('تم حفظ النتيجة بنجاح في ملفك!', 'success');
                loadPatientFileData();
            } catch (error) {
                console.error("Error saving document: ", error);
                showNotification('حدث خطأ أثناء حفظ النتيجة.', 'error');
            }
        }

        async function loadPatientFileData() {
            // Unchanged from original code
            if (!currentUser) return;
            const container = document.getElementById('saved-results-container');
            container.innerHTML = '<p>جاري تحميل سجلاتك...</p>';
            try {
                const resultsCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'toolResults');
                const q = query(resultsCol, limit(50));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p>لا توجد نتائج محفوظة بعد. استخدم إحدى الأدوات الذكية واحفظ النتيجة لتظهر هنا.</p>';
                    return;
                }
                const sortedDocs = querySnapshot.docs.sort((a, b) => b.data().createdAt.toDate() - a.data().createdAt.toDate());
                let html = '';
                sortedDocs.forEach(doc => {
                    const result = doc.data();
                    html += `
                        <div class="p-4 bg-gray-50 border-r-4 border-gray-300 rounded-md">
                            <h4 class="font-bold text-lg">${result.tool}</h4>
                            <p class="text-sm text-gray-500 mb-2">تاريخ الحفظ: ${result.createdAt.toDate().toLocaleString('ar-EG')}</p>
                            <div class="text-gray-700 whitespace-pre-wrap">${result.data}</div>
                        </div>`;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error("Error loading patient data:", error);
                container.innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل سجلاتك. يرجى المحاولة مرة أخرى.</p>';
            }
        }

        // --- SMART TOOLS MODULE ---
        function initSmartTools() {
            // Unchanged from original code
            const toolModal = document.getElementById('tool-modal');
            const modalContent = document.getElementById('modal-content');
            
            const showModal = (content) => {
                modalContent.innerHTML = content;
                toolModal.classList.remove('hidden');
                setTimeout(() => {
                    toolModal.classList.add('is-open');
                    modalContent.classList.add('scale-100');
                }, 10);
                const closeButton = modalContent.querySelector('.close-modal-btn');
                if (closeButton) closeButton.addEventListener('click', hideModal);
            };

            const hideModal = () => {
                toolModal.classList.remove('is-open');
                modalContent.classList.remove('scale-100');
                setTimeout(() => {
                    toolModal.classList.add('hidden');
                    modalContent.innerHTML = '';
                }, 300);
            };
            
            toolModal.addEventListener('click', e => {
                if (e.target === toolModal) hideModal();
            });

            document.querySelectorAll('.smart-tool-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tool = button.dataset.tool;
                    let modalHTML = '';
                    switch(tool) {
                         case 'diagnosis':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تشخيص متعدد الأبعاد</h3>
                                 <p class="text-gray-600 mb-6">يرجى إدخال المعلومات التالية بأكبر قدر ممكن من التفصيل.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="symptoms" class="block text-right font-semibold mb-2">1. الأعراض الجسدية</label>
                                         <textarea id="symptoms" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: صداع نصفي، ألم في المفاصل..."></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="feelings" class="block text-right font-semibold mb-2">2. المشاعر والأفكار</label>
                                         <textarea id="feelings" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: أشعر بقلق دائم، أفكار سلبية..."></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="lifestyle" class="block text-right font-semibold mb-2">3. نمط الحياة</label>
                                         <textarea id="lifestyle" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: نومي متقطع، أعتمد على الوجبات السريعة..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">ابدأ التحليل</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'treatment-plan':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">وصفة علاجية شمولية ذكية</h3>
                                 <p class="text-gray-600 mb-6">أدخل التشخيص أو الأعراض الرئيسية، مع معلومات إضافية، للحصول على خطة علاجية مقترحة.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="diagnosis-input" class="block text-right font-semibold mb-2">1. التشخيص أو الأعراض الرئيسية</label>
                                         <textarea id="diagnosis-input" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: تشخيص بالقولون العصبي، مع قلق وتعب مستمر"></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="weight" class="block text-right font-semibold mb-2">2. الوزن (اختياري)</label>
                                         <input type="text" id="weight" class="w-full p-2 border rounded-md" placeholder="مثال: 70 كجم">
                                     </div>
                                     <div class="mb-4">
                                         <label for="history" class="block text-right font-semibold mb-2">3. تاريخ مرضي مهم (اختياري)</label>
                                         <textarea id="history" rows="2" class="w-full p-2 border rounded-md" placeholder="مثال: حساسية من البنسلين، مرض السكري"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">صمم خطتي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'awareness-exercise':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تمرين وعي موجّه</h3>
                                 <p class="text-gray-600 mb-6">صف المشاعر التي تمر بها أو الصدمة التي تود العمل عليها، وسيقوم المساعد الذكي بإنشاء تمرين كتابة موجه لك.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="repressed-feelings" class="block text-right font-semibold mb-2">المشاعر المكبوتة أو الصدمة</label>
                                         <textarea id="repressed-feelings" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: أشعر بغضب مكبوت تجاه موقف معين، أو حزن عميق بسبب تجربة سابقة..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أنشئ التمرين</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'consultation':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">استشارة طبية آلية</h3>
                                 <p class="text-gray-600 mb-6">اطرح سؤالك على مساعد د. عمر الذكي للحصول على إجابات تستند إلى مبادئ الطب الشمولي.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="question" class="block text-right font-semibold mb-2">سؤالك</label>
                                         <textarea id="question" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: ما هي أفضل الطرق لتقوية المناعة بشكل طبيعي؟"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على الإجابة</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'supplements':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">توصية مكملات غذائية</h3>
                                 <p class="text-gray-600 mb-6">صف أعراضك أو الصق نتائج تحليل الدم هنا، وسيقوم المساعد الذكي بتحليلها وتقديم توصيات للمكملات الغذائية.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="analysis-data" class="block text-right font-semibold mb-2">الأعراض أو نتائج التحليل</label>
                                         <textarea id="analysis-data" rows="5" class="w-full p-2 border rounded-md" placeholder="مثال: أعاني من تساقط الشعر، إرهاق مستمر، وأظافر هشة. أو: Vitamin D: 15 ng/mL, Ferritin: 20 µg/L"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على توصية</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'intention':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">نية اليوم</h3>
                                 <p class="text-gray-600 mb-6">احصل على نية إيجابية ومركزة لدعمك في يومك. يمكنك تحديد شعورك الحالي لجعل النية أكثر ملاءمة.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="current-feeling" class="block text-right font-semibold mb-2">شعوري الآن (اختياري)</label>
                                         <input type="text" id="current-feeling" class="w-full p-2 border rounded-md" placeholder="مثال: متوتر، سعيد، محبط، ممتن...">
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أعطني نيتي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                    }
                    showModal(modalHTML);
                    const form = document.getElementById('tool-form');
                    if (form) form.addEventListener('submit', (e) => handleToolSubmit(e, tool));
                });
            });

            async function handleApiRequest(prompt, resultsDivId) {
                // Unchanged from original code
                const resultsDiv = document.getElementById(resultsDivId);
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = `
                    <div class="ai-loader">
                        <div class="ai-loader-dots">
                            <div class="dot1"></div><div class="dot2"></div><div class="dot3"></div>
                        </div>
                        <p class="mt-2 text-[--primary-color]">جاري التحليل باستخدام الذكاء الاصطناعي...</p>
                    </div>`;
                
                const apiKey = "AIzaSyCOfNaYITDWfe6OibILsDBx6Pe6b3SeNJ4";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                       const errorData = await response.json();
                       console.error("API Error Details:", errorData);
                       throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content.parts.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else { throw new Error("Invalid API response structure"); }
                } catch (error) {
                    console.error("API Request Error:", error);
                    resultsDiv.innerHTML = '<p class="text-center text-red-500">عذراً، حدث خطأ أثناء الاتصال بالمساعد الذكي. يرجى المحاولة مرة أخرى.</p>';
                    return null;
                }
            }
            
            async function handleToolSubmit(e, tool) {
                // Unchanged from original code
                e.preventDefault();
                let prompt = '', toolTitle = '', rawInputForSaving = '';
                 switch(tool) {
                    case 'diagnosis':
                        toolTitle = "تشخيص متعدد الأبعاد";
                        const symptoms = document.getElementById('symptoms').value;
                        const feelings = document.getElementById('feelings').value;
                        const lifestyle = document.getElementById('lifestyle').value;
                        rawInputForSaving = `الأعراض: ${symptoms}\nالمشاعر: ${feelings}\nنمط الحياة: ${lifestyle}`;
                        if (!symptoms && !feelings && !lifestyle) { showNotification('يرجى إدخال بعض المعلومات للتحليل.', 'warning'); return; }
                        prompt = `Act as a holistic medicine expert. Analyze the user's input based on a tripartite model (organic, emotional, energetic) and provide a probable diagnosis or assessment. User Input -> Symptoms: "${symptoms}", Feelings: "${feelings}", Lifestyle: "${lifestyle}". Structure the output as a clean, readable text in Arabic with three main sections: "الاحتمال العضوي", "الجذر الشعوري", and "التوازن الطاقي المختل". Use markdown for formatting.`;
                        break;
                    case 'treatment-plan':
                        toolTitle = "وصفة علاجية شمولية";
                        const diagnosisInput = document.getElementById('diagnosis-input').value;
                        const weight = document.getElementById('weight').value;
                        const history = document.getElementById('history').value;
                        rawInputForSaving = `التشخيص: ${diagnosisInput}\nالوزن: ${weight}\nالتاريخ المرضي: ${history}`;
                        if (!diagnosisInput) { showNotification('يرجى إدخال التشخيص أو الأعراض الرئيسية.', 'warning'); return; }
                        prompt = `As a functional medicine doctor, design a comprehensive 21-day holistic treatment plan for a patient. Patient details -> Diagnosis/Symptoms: "${diagnosisInput}", Weight: "${weight}", Medical History: "${history}". The plan should include sections for: "الأدوية أو المكملات المقترحة", "توصيات التغذية", "تمارين تأمل أو وعي", and "نصائح طاقة ونمط حياة". Present the output in a well-structured, easy-to-read format in Arabic using markdown. It should be a general daily plan, not a strict schedule.`;
                        break;
                    case 'awareness-exercise':
                        toolTitle = "تمرين وعي موجّه";
                        const repressedFeelings = document.getElementById('repressed-feelings').value;
                        rawInputForSaving = `المشاعر: ${repressedFeelings}`;
                        if (!repressedFeelings) { showNotification('يرجى وصف مشاعرك.', 'warning'); return; }
                        prompt = `You are a therapeutic writing coach. Based on the user's stated repressed feelings or past trauma, create a guided expressive writing exercise. User's input: "${repressedFeelings}". The output should be in Arabic and include: 1. A short, gentle introduction. 2. A series of 3-5 reflective writing prompts. 3. A concluding emotional guidance on how to process what they've written. Format the output with clear headings using markdown.`;
                        break;
                    case 'consultation':
                        toolTitle = "استشارة طبية آلية";
                        const question = document.getElementById('question').value;
                        rawInputForSaving = `السؤال: ${question}`;
                        if (!question) { showNotification('يرجى كتابة سؤالك.', 'warning'); return; }
                        prompt = `As a holistic medicine assistant for Dr. Omar, answer the following question in Arabic, incorporating principles of holistic, functional, and spiritual medicine where appropriate. Keep the tone empathetic and informative. Question: "${question}"`;
                        break;
                    case 'supplements':
                         toolTitle = "توصية مكملات غذائية";
                        const analysisData = document.getElementById('analysis-data').value;
                        rawInputForSaving = `البيانات: ${analysisData}`;
                        if (!analysisData) { showNotification('يرجى إدخال الأعراض أو نتائج التحليل.', 'warning'); return; }
                        prompt = `As a functional medicine expert, analyze the provided symptoms or blood test results and recommend the most effective supplements. Include recommended timing (e.g., with food, in the morning) and any potential warnings. Input: "${analysisData}". The output should be a clear, bulleted list in Arabic, with each supplement having its own section for "التوقيت" and "تحذيرات".`;
                        break;
                    case 'intention':
                        toolTitle = "نية اليوم";
                        const currentFeeling = document.getElementById('current-feeling').value;
                        rawInputForSaving = `الشعور: ${currentFeeling}`;
                        prompt = `As a spiritual wellness coach, provide a supportive, healing daily intention for the user. If the user provides their current feeling, tailor the intention to it. User's feeling: "${currentFeeling}". The output should be a single, powerful intention sentence in Arabic, followed by a short (1-2 sentences) "تمرين دعم داخلي" to help them embody that intention.`;
                        break;
                }
                const responseText = await handleApiRequest(prompt, 'tool-results');
                if (responseText) {
                    const resultsDiv = document.getElementById('tool-results');
                    resultsDiv.innerHTML = `
                        <div id="result-content" class="p-4 bg-gray-50 rounded-md text-right whitespace-pre-wrap border">${responseText}</div>
                        <div class="mt-4 text-left">
                            ${currentUser ? '<button id="save-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ النتيجة</button>' : ''}
                            <button id="download-pdf-btn" class="btn btn-primary text-white py-2 px-4 rounded-full mr-2 text-sm">تحميل كـ PDF</button>
                        </div>`;
                    if (currentUser) {
                         document.getElementById('save-result-btn').addEventListener('click', () => {
                             const fullResultText = `--- المدخلات ---\n${rawInputForSaving}\n\n--- نتيجة التحليل ---\n${responseText}`;
                             saveResultToFirestore(toolTitle, fullResultText)
                         });
                    }
                    document.getElementById('download-pdf-btn').addEventListener('click', () => downloadResultAsPDF('result-content', toolTitle));
                }
            }
        }
        
        // --- PDF DOWNLOAD MODULE ---
        function downloadResultAsPDF(elementId, title) {
            // Unchanged from original code
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);
            if (!element) return;
            showNotification("جاري إعداد ملف الـ PDF...", 'warning', 2000);
            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                pdf.setProperties({ title: `تقرير ${title} - د. عمر العماد`, author: 'موقع د. عمر العماد - TibraSoul' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 20;
                const imgHeight = imgWidth / (canvas.width / canvas.height);
                let heightLeft = imgHeight;
                let position = 15;
                pdf.setFont('Amiri', 'normal'); 
                pdf.text(title, pdfWidth / 2, 10, { align: 'center' });
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - position - 10);
                while (heightLeft > 0) {
                    position = -heightLeft - 10;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                pdf.save(`${title.replace(/\s+/g, '-')}_${new Date().toISOString().split('T')[0]}.pdf`);
            });
        }

        // --- FREQUENCY GENERATOR MODULE ---
        function initFrequencyGenerator() {
            // Unchanged from original code
            const freqButtonsContainer = document.getElementById('frequency-buttons');
            const stopFreqBtn = document.getElementById('stop-freq-btn');
            const canvas = document.getElementById('frequency-canvas');
            if (!freqButtonsContainer || !stopFreqBtn || !canvas) return;

            let oscillator, analyser;
            const canvasCtx = canvas.getContext('2d');
            let animationFrameId;

            const setupAudio = async () => {
                if (oscillator) return;
                try {
                    await Tone.start();
                    oscillator = new Tone.Oscillator({type: 'sine'}).toDestination();
                    analyser = new Tone.Analyser('waveform', 1024);
                    oscillator.connect(analyser);
                } catch(e) { console.error("Tone.js setup failed:", e); showNotification("فشل تهيئة الصوت. قد تحتاج إلى التفاعل مع الصفحة أولاً.", "warning"); }
            };
            const playFrequency = async (freq) => {
                await setupAudio();
                if (!oscillator) return;
                oscillator.frequency.value = freq;
                if (Tone.context.state !== 'running') await Tone.start();
                if (oscillator.state !== 'started') oscillator.start();
                stopFreqBtn.classList.remove('hidden');
                visualize();
            };
            const stopFrequency = () => {
                if (oscillator && oscillator.state === "started") { oscillator.stop(); oscillator.dispose(); oscillator = null; }
                stopFreqBtn.classList.add('hidden');
                document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                clearCanvas();
            };
            function visualize() {
                animationFrameId = requestAnimationFrame(visualize);
                if (!analyser) return;
                const waveformValues = analyser.getValue();
                canvasCtx.fillStyle = '#1a1a1a';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = 'rgb(129, 178, 154)';
                canvasCtx.beginPath();
                const sliceWidth = canvas.width * 1.0 / waveformValues.length;
                let x = 0;
                for (let i = 0; i < waveformValues.length; i++) {
                    const v = (waveformValues[i] + 1) / 2;
                    const y = v * canvas.height;
                    if (i === 0) canvasCtx.moveTo(x, y);
                    else canvasCtx.lineTo(x, y);
                    x += sliceWidth;
                }
                canvasCtx.stroke();
            }
            const clearCanvas = () => { if (canvasCtx) { canvasCtx.fillStyle = '#1a1a1a'; canvasCtx.fillRect(0, 0, canvas.width, canvas.height); } };
            freqButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.freq-btn');
                if (button) {
                    const isActive = button.classList.contains('active');
                    stopFrequency(); 
                    if (!isActive) {
                         document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
                         button.classList.add('active');
                         playFrequency(parseFloat(button.dataset.freq));
                    }
                }
            });
            stopFreqBtn.addEventListener('click', stopFrequency);
            clearCanvas();
        }

        // --- BLOG MODULE ---
        function initBlog() {
            // Unchanged from original code
            const posts = {
                'gut-brain': {
                    title: 'هل أمعاؤك هي سبب تقلبات مزاجك؟ العقل الثاني الذي يسكن أحشاءك',
                    image: 'https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070&auto=format&fit=crop',
                    content: `<p>محتوى المقال...</p>`
                },
                'breathing': {
                    title: 'قوة التنفس: كيف تهدئ جهازك العصبي في 5 دقائق',
                    image: 'https://images.unsplash.com/photo-1599301934984-1d2741913a5f?q=80&w=2070&auto=format&fit=crop',
                    content: `<p>محتوى المقال...</p>`
                },
                'supplements': {
                    title: 'أفضل 3 مكملات غذائية لمكافحة الالتهابات',
                    image: 'https://images.unsplash.com/photo-1476837579993-f1d3948f17c2?q=80&w=2070&auto=format&fit=crop',
                    content: `<p>محتوى المقال...</p>`
                }
            };
            const postTitleEl = document.getElementById('post-title');
            const postImageEl = document.getElementById('post-image');
            const postContentEl = document.getElementById('post-content');
            document.querySelectorAll('.read-more-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const postId = button.dataset.postid;
                    const post = posts[postId];
                    if (post) {
                        postTitleEl.textContent = post.title;
                        postImageEl.src = post.image;
                        postContentEl.innerHTML = post.content;
                        showView('single-post');
                    }
                });
            });
        }

        // --- WHEEL OF LIFE MODULE (NEW) ---
        function initWheelOfLife() {
            const ctx = document.getElementById('wheel-of-life-chart');
            const slidersContainer = document.getElementById('wheel-of-life-sliders');
            if (!ctx || !slidersContainer) return;

            const categories = [
                { id: 'health', label: 'الصحة الجسدية', icon: 'fa-heart-pulse', color: 'rgba(231, 76, 60, 0.6)' },
                { id: 'career', label: 'الحياة المهنية', icon: 'fa-briefcase', color: 'rgba(52, 152, 219, 0.6)' },
                { id: 'finance', label: 'الوضع المالي', icon: 'fa-sack-dollar', color: 'rgba(46, 204, 113, 0.6)' },
                { id: 'spirituality', label: 'الروحانيات', icon: 'fa-om', color: 'rgba(155, 89, 182, 0.6)' },
                { id: 'relationships', label: 'العلاقات', icon: 'fa-users', color: 'rgba(241, 196, 15, 0.6)' },
                { id: 'personal_growth', label: 'النمو الشخصي', icon: 'fa-seedling', color: 'rgba(26, 188, 156, 0.6)' },
                { id: 'environment', label: 'البيئة المحيطة', icon: 'fa-house-chimney', color: 'rgba(230, 126, 34, 0.6)' },
                { id: 'fun', label: 'المرح والترفيه', icon: 'fa-puzzle-piece', color: 'rgba(243, 156, 18, 0.6)' }
            ];

            slidersContainer.innerHTML = categories.map(cat => `
                <div class="flex items-center gap-4">
                    <label for="${cat.id}-slider" class="w-40 text-right font-semibold"><i class="fas ${cat.icon} text-[--primary-color] ml-2"></i>${cat.label}</label>
                    <input type="range" id="${cat.id}-slider" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider" data-category="${cat.id}">
                    <span id="${cat.id}-value" class="font-bold w-8 text-center text-[--primary-dark]">5</span>
                </div>
            `).join('');

            const chartData = {
                labels: categories.map(c => c.label),
                datasets: [{
                    label: 'تقييم الرضا', data: categories.map(() => 5),
                    backgroundColor: 'rgba(90, 110, 90, 0.4)', // Main color from user's theme
                    borderColor: 'rgba(90, 110, 90, 1)',
                    borderWidth: 2, pointBackgroundColor: '#fff', pointBorderColor: '#435243',
                    pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            };

            const chartConfig = {
                type: 'radar', data: chartData,
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: { font: { family: "'Noto Kufi Arabic', sans-serif", size: 14 }, color: '#333' },
                            ticks: { backdropColor: 'transparent', color: 'rgba(0, 0, 0, 0.5)', stepSize: 2 },
                            min: 0, max: 10
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            };
            
            wheelChart = new Chart(ctx, chartConfig);

            document.querySelectorAll('.range-slider').forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const value = e.target.value;
                    const categoryId = e.target.dataset.category;
                    document.getElementById(`${categoryId}-value`).textContent = value;
                    const categoryIndex = categories.findIndex(cat => cat.id === categoryId);
                    wheelChart.data.datasets[0].data[categoryIndex] = value;
                    wheelChart.update();
                });
            });

            document.getElementById('get-wheel-insight-btn').addEventListener('click', getWheelInsight);
        }

        async function getWheelInsight() {
            const resultDiv = document.getElementById('wheel-of-life-result');
            const data = wheelChart.data.datasets[0].data;
            const labels = wheelChart.data.labels;

            const scores = labels.map((label, index) => ({ label: label, score: data[index] }));
            const sortedScores = [...scores].sort((a, b) => a.score - b.score);
            const lowestAreas = sortedScores.slice(0, 2);

            resultDiv.innerHTML = `<div class="ai-loader">
                <div class="ai-loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div>
                <p class="mt-2 text-[--primary-color]">يقوم مساعدنا الذكي بتحليل تقييمك...</p>
            </div>`;
            resultDiv.classList.remove('hidden');
            setTimeout(() => resultDiv.style.opacity = 1, 10);
            
            const prompt = `Act as an empathetic holistic wellness coach. A user has completed a 'Wheel of Life' assessment. Their two lowest-scoring areas are "${lowestAreas[0].label}" (Score: ${lowestAreas[0].score}) and "${lowestAreas[1].label}" (Score: ${lowestAreas[1].score}). Provide a short, encouraging, and insightful analysis in Arabic. Start by acknowledging their self-reflection. Then, briefly explain how these two areas might be interconnected. Finally, suggest ONE concrete, simple first step they can take. The tone should be supportive, not clinical. Use markdown for gentle formatting.`;
            
            const apiKey = "AIzaSyCOfNaYITDWfe6OibILsDBx6Pe6b3SeNJ4"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                 if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                const apiData = await response.json();
                const insightText = apiData.candidates[0].content.parts[0].text;
                
                resultDiv.innerHTML = `
                     <h4 class="text-xl font-bold mb-3 text-[--primary-color]">رؤى من أجل توازنك</h4>
                     <div class="text-right whitespace-pre-wrap">${insightText}</div>
                     <div class="mt-4 text-left">
                         ${currentUser ? '<button id="save-wheel-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ التقييم</button>' : '<p class="text-sm text-gray-500">سجل دخولك لحفظ هذا التقييم في ملفك.</p>'}
                     </div>
                `;
                if(currentUser){
                    document.getElementById('save-wheel-result-btn').addEventListener('click', () => {
                        const resultToSave = scores.map(s => `${s.label}: ${s.score}`).join('\n');
                        const fullResult = `--- تقييم عجلة العافية ---\n${resultToSave}\n\n--- رؤية المساعد الذكي ---\n${insightText}`;
                        saveResultToFirestore("تقييم عجلة العافية", fullResult);
                    });
                }
            } catch (error) {
                console.error("Wheel of Life Insight Error:", error);
                resultDiv.innerHTML = '<p class="text-red-500">عذراً، حدث خطأ أثناء توليد رؤيتك. يرجى المحاولة مرة أخرى.</p>';
            }
        }
        
        // --- AUDIO PLAYER MODULE (NEW) ---
        function initAudioPlayer() {
            const audio = document.getElementById('guided-audio');
            const playPauseBtn = document.getElementById('audio-play-pause-btn');
            const icon = playPauseBtn.querySelector('i');
            const timeDisplay = document.getElementById('audio-time');
            const progressBar = document.getElementById('audio-progress-bar');
            if(!audio) return;

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            };
            
            const togglePlay = () => {
                if (audio.paused) {
                    audio.play();
                    icon.classList.replace('fa-play-circle', 'fa-pause-circle');
                } else {
                    audio.pause();
                    icon.classList.replace('fa-pause-circle', 'fa-play-circle');
                }
            };
            
            const updateProgress = () => {
                progressBar.value = (audio.currentTime / audio.duration) * 100 || 0;
                timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration || 60)}`;
            };
            
            const setProgress = () => { audio.currentTime = (progressBar.value / 100) * audio.duration; };

            playPauseBtn.addEventListener('click', togglePlay);
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('loadedmetadata', updateProgress);
            audio.addEventListener('ended', () => icon.classList.replace('fa-pause-circle', 'fa-play-circle'));
            progressBar.addEventListener('input', setProgress);
        }

        // --- GENERAL UI & CREATIVE EFFECTS ---
        function initGeneralUI() {
            // Unchanged from original code
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            mobileMenu.addEventListener('click', (e) => { 
                if(e.target.classList.contains('nav-link') || e.target.closest('.nav-link')){
                     mobileMenu.classList.add('hidden');
                }
             });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('is-visible');
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
        }

        function initCreativeEffects() {
            // Unchanged from original code
            const cards = document.querySelectorAll('.dashboard-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = card.offsetWidth / 2;
                    const centerY = card.offsetHeight / 2;
                    const rotateX = ((y - centerY) / centerY) * -5;
                    const rotateY = ((x - centerX) / centerX) * 5;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });

            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    const rect = button.getBoundingClientRect();
                    const ripple = document.createElement('span');
                    const diameter = Math.max(button.clientWidth, button.clientHeight);
                    const radius = diameter / 2;
                    ripple.style.width = ripple.style.height = `${diameter}px`;
                    ripple.style.left = `${e.clientX - rect.left - radius}px`;
                    ripple.style.top = `${e.clientY - rect.top - radius}px`;
                    ripple.classList.add('ripple');
                    const existingRipple = button.querySelector('.ripple');
                    if(existingRipple) { existingRipple.remove(); }
                    button.appendChild(ripple);
                });
            });
        }
    </script>
</body>
</html>
