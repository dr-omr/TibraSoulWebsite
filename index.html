<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ṭibra - Your Digital Sanctuary</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.13.0/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- GLOBAL STYLES & RESET --- */
        :root {
            --bg-color: #F4F1EA;
            --primary-text: #3D405B;
            --secondary-text: #81B29A;
            --accent-color: #E07A5F;
            --sand-color: #EADDC6;
            --rake-color: #D4C4A8;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --font-primary: 'Merriweather', serif;
            --font-secondary: 'Montserrat', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-secondary);
            background-color: var(--bg-color);
            color: var(--primary-text);
            line-height: 1.6;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- UI CONTAINERS --- */
       .auth-container,.main-app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out;
        }

       .hidden {
            display: none!important;
        }

        /* --- AUTH SCREEN --- */
       .auth-container {
            text-align: center;
        }
       .auth-container h1 {
            font-family: var(--font-primary);
            font-size: 3rem;
            margin-bottom: 1rem;
        }
       .auth-container p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            max-width: 500px;
        }
       .google-signin-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: background-color 0.3s;
        }
       .google-signin-btn:hover {
            background-color: #357ae8;
        }

        /* --- MAIN APP LAYOUT --- */
       .main-app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 60px 1fr;
            grid-template-areas:
                "header header"
                "sidebar content";
            width: 100vw;
            height: 100vh;
        }

        header {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            background-color: white;
            box-shadow: 0 2px 5px var(--shadow-color);
            z-index: 10;
        }
        
        header.logo {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            color: var(--accent-color);
        }

       .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

       .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

       .logout-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
       .logout-btn:hover {
            background: #c76b50;
        }

        aside {
            grid-area: sidebar;
            background-color: #fff;
            padding: 2rem 1rem;
            border-right: 1px solid #e0e0e0;
        }

        aside nav ul {
            list-style: none;
        }

        aside nav li {
            margin-bottom: 1rem;
        }

        aside nav a {
            text-decoration: none;
            color: var(--primary-text);
            font-size: 1.1rem;
            padding: 10px 15px;
            display: block;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        aside nav a.active, aside nav a:hover {
            background-color: var(--bg-color);
            color: var(--accent-color);
        }

        main {
            grid-area: content;
            overflow-y: auto;
            padding: 2rem;
            background-color: var(--bg-color);
        }

       .content-section {
            display: none;
        }
       .content-section.active {
            display: block;
        }

        h2 {
            font-family: var(--font-primary);
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: var(--secondary-text);
        }
        
        button {
            font-family: var(--font-secondary);
        }

        /* --- ZEN GARDEN SECTION --- */
        #zen-garden-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: var(--sand-color);
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            position: relative;
            margin-bottom: 1rem;
        }
        #zen-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
       .garden-controls {
            display: flex;
            gap: 1rem;
        }
       .garden-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--secondary-text);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
       .garden-controls button:hover {
            background-color: #6a9a7f;
        }

        /* --- JOURNAL SECTION --- */
       .journal-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 180px);
        }
       .journal-entry-area,.journal-history-area {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
       .journal-history-area {
            overflow-y: auto;
        }
        #journal-textarea {
            width: 100%;
            height: calc(100% - 60px);
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            font-family: var(--font-primary);
            font-size: 1rem;
            resize: none;
        }
        #save-journal-btn {
            width: 100%;
            padding: 12px;
            margin-top: 1rem;
            border: none;
            border-radius: 5px;
            background-color: var(--accent-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        #save-journal-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
       .journal-post {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px dashed #eee;
        }
       .journal-post:last-child {
            border-bottom: none;
        }
       .journal-post p {
            margin-bottom: 0.5rem;
        }
       .journal-post.timestamp {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 1rem;
        }
       .gemini-response {
            background-color: #f9f9f9;
            border-left: 3px solid var(--secondary-text);
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            font-style: italic;
        }
       .gemini-response.processing::before {
            content: 'Ṭibra is reflecting...';
            color: #999;
        }
        
        /* --- SOUNDSCAPE SECTION --- */
       .soundscape-mixer {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
       .sound-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
       .sound-control label {
            width: 100px;
        }
       .sound-control input[type="range"] {
            flex-grow: 1;
            cursor: pointer;
        }
        #master-play-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--secondary-text);
            color: white;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* --- PROFILE SECTION --- */
       .profile-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
       .profile-card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
        }
       .profile-card h3 {
            font-family: var(--font-primary);
            color: var(--primary-text);
            margin-bottom: 1.5rem;
        }
       .breathing-circle {
            width: 150px;
            height: 150px;
            background-color: var(--secondary-text);
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 600;
            animation: breathe 8s ease-in-out infinite;
        }
        @keyframes breathe {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }
        #growth-tree-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        #zen-snapshot-container img {
            width: 100%;
            border-radius: 8px;
            border: 5px solid white;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        #zen-snapshot-container p {
            margin-top: 1rem;
            color: #999;
        }

    </style>
</head>
<body>

    <div id="auth-container" class="auth-container">
        <h1>Welcome to Ṭibra</h1>
        <p>Your personal sanctuary for mindfulness, reflection, and growth. Begin your journey by signing in.</p>
        <button id="google-signin-btn" class="google-signin-btn">
            <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.64-.06-1.25-.16-1.84H9.18v3.48h4.79c-.2 1.12-.84 2.08-1.79 2.73v2.26h2.9c1.7-1.56 2.67-3.88 2.67-6.63z"></path><path fill="#34A853" d="M9.18 18c2.43 0 4.47-.8 5.96-2.18l-2.9-2.26c-.8.54-1.84.86-2.97.86-2.28 0-4.22-1.54-4.9-3.61H1.28v2.33C2.74 16.5 5.7 18 9.18 18z"></path><path fill="#FBBC05" d="M4.28 10.79c-.12-.36-.18-.75-.18-1.15s.06-.79.18-1.15V6.16H1.28C.48 7.73 0 9.77 0 12s.48 4.27 1.28 5.84l3-2.33z"></path><path fill="#EA4335" d="M9.18 3.54c1.32 0 2.5.45 3.44 1.34l2.58-2.58C13.65.88 11.61 0 9.18 0 5.7 0 2.74 1.5 1.28 4.16l3 2.33c.68-2.07 2.62-3.61 4.9-3.61z"></path></svg>
            <span>Sign in with Google</span>
        </button>
    </div>

    <div id="main-app-container" class="main-app-container hidden">
        <header>
            <div class="logo">Ṭibra</div>
            <div class="user-info">
                <img id="user-avatar" src="" alt="User Avatar">
                <span id="user-name"></span>
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>
        </header>

        <aside>
            <nav>
                <ul>
                    <li><a href="#profile" class="nav-link active">My Journey</a></li>
                    <li><a href="#zen-garden" class="nav-link">Zen Garden</a></li>
                    <li><a href="#journal" class="nav-link">Journal</a></li>
                    <li><a href="#soundscape" class="nav-link">Soundscape</a></li>
                </ul>
            </nav>
        </aside>

        <main>
            <section id="profile" class="content-section active">
                <h2>My Journey</h2>
                <div class="profile-layout">
                    <div class="profile-card">
                        <h3>Mindful Breathing</h3>
                        <div class="breathing-circle">Breathe</div>
                        <p style="margin-top: 1.5rem; color: #888;">Follow the rhythm. Inhale as it grows, exhale as it shrinks.</p>
                    </div>
                    <div class="profile-card">
                        <h3>Your Growth</h3>
                        <div id="growth-tree-container"></div>
                        <p style="margin-top: 1rem;" id="journal-count-text">You have written 0 journal entries.</p>
                    </div>
                    <div class="profile-card">
                        <h3>Your Zen Garden</h3>
                        <div id="zen-snapshot-container">
                            <p>Create and save a snapshot of your Zen Garden to see it here.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="zen-garden" class="content-section">
                <h2>Digital Zen Garden</h2>
                <p style="margin-bottom: 1.5rem;">Create a space of calm. Click and drag on the sand to rake your patterns.</p>
                <div id="zen-garden-container">
                    <canvas id="zen-canvas"></canvas>
                </div>
                <div class="garden-controls">
                    <button id="clear-garden-btn">Clear Sand</button>
                    <button id="save-garden-btn">Save Snapshot</button>
                </div>
            </section>

            <section id="journal" class="content-section">
                <h2>AI-Powered Journal</h2>
                <div class="journal-layout">
                    <div class="journal-entry-area">
                        <h3>New Entry</h3>
                        <textarea id="journal-textarea" placeholder="What's on your mind?"></textarea>
                        <button id="save-journal-btn">Save & Reflect</button>
                    </div>
                    <div class="journal-history-area">
                        <h3>Past Entries</h3>
                        <div id="journal-history-container">
                            <p>Your journal entries will appear here.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="soundscape" class="content-section">
                <h2>Dynamic Soundscape</h2>
                <div class="soundscape-mixer">
                    <p style="margin-bottom: 2rem;">Adjust the sliders to create your perfect ambient sound mix. Press Play to begin.</p>
                    
                    <div class="sound-control">
                        <label for="rain-slider">Rain</label>
                        <input type="range" id="rain-slider" class="volume-slider" data-audio="rain-audio" min="0" max="100" value="0">
                    </div>
                    <audio id="rain-audio" src="https://www.soundjay.com/nature/rain-03.mp3" loop></audio>
                    
                    <div class="sound-control">
                        <label for="wind-slider">Wind</label>
                        <input type="range" id="wind-slider" class="volume-slider" data-audio="wind-audio" min="0" max="100" value="0">
                    </div>
                     <audio id="wind-audio" src="https://www.soundjay.com/nature/wind-howl-01.mp3" loop></audio>

                    <div class="sound-control">
                        <label for="chimes-slider">Chimes</label>
                        <input type="range" id="chimes-slider" class="volume-slider" data-audio="chimes-audio" min="0" max="100" value="0">
                    </div>
                    <audio id="chimes-audio" src="https://www.soundjay.com/misc/wind-chime-1.mp3" loop></audio>

                    <button id="master-play-btn">Play Soundscape</button>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        // =================================================================================
        // === FIREBASE SDK IMPORTS & INITIALIZATION =======================================
        // =================================================================================
        
        // These modules are imported from the Firebase CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Replace the following object with your app's Firebase project configuration.
        // You can find this in your Firebase project settings.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // =================================================================================
        // === DOM ELEMENT SELECTORS =======================================================
        // =================================================================================
        
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameEl = document.getElementById('user-name');
        const userAvatarEl = document.getElementById('user-avatar');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');

        // =================================================================================
        // === GLOBAL STATE ================================================================
        // =================================================================================

        let currentUser = null;
        let unsubscribeJournalListener = null;

        // =================================================================================
        // === AUTHENTICATION MODULE =======================================================
        // =================================================================================

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                await setupUser(user);
                authContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                updateUserInfoUI(user);
                initializeActiveFeatures();
            } else {
                // User is signed out
                currentUser = null;
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                if (unsubscribeJournalListener) {
                    unsubscribeJournalListener();
                }
            }
        });

        // Handle Google Sign-In
        googleSignInBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Authentication Error: ", error);
                alert("Could not sign in. Please try again.");
            });
        });

        // Handle Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => {
                console.error("Sign Out Error: ", error);
            });
        });
        
        // Setup user profile in Firestore on first login
        async function setupUser(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                // New user, create profile
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: serverTimestamp(),
                    journalEntriesCount: 0,
                    zenGardenImageUrl: null
                });
            }
        }
        
        function updateUserInfoUI(user) {
            userNameEl.textContent = user.displayName;
            userAvatarEl.src = user.photoURL;
        }

        // =================================================================================
        // === NAVIGATION MODULE ===========================================================
        // =================================================================================

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                // Update active link
                navLinks.forEach(nav => nav.classList.remove('active'));
                link.classList.add('active');

                // Update active content section
                contentSections.forEach(section => {
                    if (section.id === targetId) {
                        section.classList.add('active');
                    } else {
                        section.classList.remove('active');
                    }
                });
                
                // Re-initialize features if they are now visible
                if (targetId === 'profile') loadProfileData();
                if (targetId === 'zen-garden' &&!zenGardenInitialized) initZenGarden();
            });
        });
        
        function initializeActiveFeatures() {
            // This function is called on login to load data for the default view
            loadProfileData();
        }

        // =================================================================================
        // === PROFILE MODULE ==============================================================
        // =================================================================================
        
        const growthTreeContainer = document.getElementById('growth-tree-container');
        const journalCountText = document.getElementById('journal-count-text');
        const zenSnapshotContainer = document.getElementById('zen-snapshot-container');
        let growthTreeAnim;
        
        function initGrowthTree() {
            // Lottie animation JSON data (replace with your chosen animation)
            const animationData = {"v":"5.5.2","fr":30,"ip":0,"op":150,"w":500,"h":500,"nm":"Plant Growth","ddd":0,"assets":,"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Plant","ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":,"ix":2},"a":{"a":0,"k":,"ix":1},"s":{"a":0,"k":,"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ind":0,"ty":"sh","ix":1,"ks":{"a":1,"k":{"i":[,,],"o":[,,],"v":[[[0,-50],],[[-25,-25],[-13.8,0]],[[0,-50],]],"c":false},"ix":2},"nm":"Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[0.4,0.6,0.2,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":,"ix":2},"a":{"a":0,"k":,"ix":1},"s":{"a":0,"k":,"ix":6},"r":{"a":0,"k":0,"ix":10},"o":{"a":0,"k":100,"ix":11},"sk":{"a":0,"k":0,"ix":14},"sa":{"a":0,"k":0,"ix":15},"nm":"Transform"}],"nm":"Stem","np":3,"cix":2,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"gr","it":[{"ind":0,"ty":"sh","ix":1,"ks":{"a":1,"k":{"i":[,,],"o":[,,],"v":[[[0,-100],],[[-50,-50],[-27.6,0]],[[0,-100],]],"c":false},"ix":2},"nm":"Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[0.2,0.8,0.3,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":,"ix":2},"a":{"a":0,"k":,"ix":1},"s":{"a":0,"k":,"ix":6},"r":{"a":0,"k":0,"ix":10},"o":{"a":0,"k":100,"ix":11},"sk":{"a":0,"k":0,"ix":14},"sa":{"a":0,"k":0,"ix":15},"nm":"Transform"}],"nm":"Leaf 1","np":3,"cix":2,"ix":2,"mn":"ADBE Vector Group","hd":false},{"ty":"gr","it":[{"ind":0,"ty":"sh","ix":1,"ks":{"a":1,"k":{"i":[,,],"o":[,,],"v":[[[0,-100],],[[50,-50],[27.6,0]],[[0,-100],]],"c":false},"ix":2},"nm":"Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[0.2,0.8,0.3,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":,"ix":2},"a":{"a":0,"k":,"ix":1},"s":{"a":0,"k":,"ix":6},"r":{"a":0,"k":0,"ix":10},"o":{"a":0,"k":100,"ix":11},"sk":{"a":0,"k":0,"ix":14},"sa":{"a":0,"k":0,"ix":15},"nm":"Transform"}],"nm":"Leaf 2","np":3,"cix":2,"ix":3,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":150,"st":0,"bm":0}]};

            growthTreeAnim = lottie.loadAnimation({
                container: growthTreeContainer,
                renderer: 'svg',
                loop: false,
                autoplay: false,
                animationData: animationData
            });
        }
        
        async function loadProfileData() {
            if (!currentUser) return;
            if (!growthTreeAnim) initGrowthTree();
            
            const userRef = doc(db, "users", currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const journalCount = userData.journalEntriesCount |
| 0;
                
                // Update journal count text
                journalCountText.textContent = `You have written ${journalCount} journal entries. Keep growing!`;
                
                // Update growth tree animation
                const totalFrames = growthTreeAnim.totalFrames;
                const maxEntriesForFullGrowth = 20; // Arbitrary number for full growth
                let progress = Math.min(journalCount / maxEntriesForFullGrowth, 1);
                let targetFrame = Math.floor(progress * totalFrames);
                growthTreeAnim.goToAndStop(targetFrame, true);
                
                // Update Zen Garden snapshot
                if (userData.zenGardenImageUrl) {
                    zenSnapshotContainer.innerHTML = `<img src="${userData.zenGardenImageUrl}" alt="Your Zen Garden">`;
                } else {
                    zenSnapshotContainer.innerHTML = `<p>Create and save a snapshot of your Zen Garden to see it here.</p>`;
                }
            }
        }

        // =================================================================================
        // === ZEN GARDEN MODULE ===========================================================
        // =================================================================================

        const zenCanvas = document.getElementById('zen-canvas');
        const gardenContainer = document.getElementById('zen-garden-container');
        const clearGardenBtn = document.getElementById('clear-garden-btn');
        const saveGardenBtn = document.getElementById('save-garden-btn');
        let zenCtx, isRaking = false, zenGardenInitialized = false;

        function initZenGarden() {
            const rect = gardenContainer.getBoundingClientRect();
            zenCanvas.width = rect.width;
            zenCanvas.height = rect.height;
            zenCtx = zenCanvas.getContext('2d');
            drawSand();
            
            zenCanvas.addEventListener('mousedown', startRaking);
            zenCanvas.addEventListener('mouseup', stopRaking);
            zenCanvas.addEventListener('mouseleave', stopRaking);
            zenCanvas.addEventListener('mousemove', rake);
            
            clearGardenBtn.addEventListener('click', drawSand);
            saveGardenBtn.addEventListener('click', saveGardenSnapshot);
            zenGardenInitialized = true;
        }

        function drawSand() {
            zenCtx.fillStyle = '#EADDC6'; // Sand color
            zenCtx.fillRect(0, 0, zenCanvas.width, zenCanvas.height);
            // Add some noise for texture
            for (let i = 0; i < 20000; i++) {
                let x = Math.random() * zenCanvas.width;
                let y = Math.random() * zenCanvas.height;
                zenCtx.fillStyle = `rgba(0,0,0,${Math.random() * 0.05})`;
                zenCtx.fillRect(x, y, 1, 1);
            }
        }

        function startRaking(e) {
            isRaking = true;
            zenCtx.beginPath();
            zenCtx.moveTo(e.offsetX, e.offsetY);
        }

        function stopRaking() {
            isRaking = false;
        }

        function rake(e) {
            if (!isRaking) return;
            zenCtx.lineWidth = 4;
            zenCtx.lineCap = 'round';
            zenCtx.strokeStyle = '#D4C4A8'; // Rake color
            zenCtx.lineTo(e.offsetX, e.offsetY);
            zenCtx.stroke();
            zenCtx.beginPath();
            zenCtx.moveTo(e.offsetX, e.offsetY);
        }
        
        async function saveGardenSnapshot() {
            if (!currentUser) return;
            saveGardenBtn.textContent = 'Saving...';
            saveGardenBtn.disabled = true;

            try {
                const canvas = await html2canvas(gardenContainer);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // Use JPEG for smaller file size
                
                const storageRef = ref(storage, `users/${currentUser.uid}/zen-garden.jpg`);
                await uploadString(storageRef, dataUrl, 'data_url');
                
                const downloadURL = await getDownloadURL(storageRef);
                
                const userRef = doc(db, "users", currentUser.uid);
                await setDoc(userRef, { zenGardenImageUrl: downloadURL }, { merge: true });
                
                alert('Your Zen Garden has been saved to your Journey profile!');
                loadProfileData(); // Refresh profile to show new image
            } catch (error) {
                console.error("Error saving snapshot: ", error);
                alert("Could not save your garden. Please try again.");
            } finally {
                saveGardenBtn.textContent = 'Save Snapshot';
                saveGardenBtn.disabled = false;
            }
        }

        // =================================================================================
        // === JOURNAL MODULE ==============================================================
        // =================================================================================
        
        const journalTextarea = document.getElementById('journal-textarea');
        const saveJournalBtn = document.getElementById('save-journal-btn');
        const journalHistoryContainer = document.getElementById('journal-history-container');
        
        // --- Gemini API Configuration ---
        // IMPORTANT: Storing your API key in client-side code is insecure and for
        // prototyping only. For production, use a server-side proxy like a Cloud Function.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        saveJournalBtn.addEventListener('click', saveJournalEntry);
        
        async function saveJournalEntry() {
            const text = journalTextarea.value.trim();
            if (!text ||!currentUser) return;
            
            saveJournalBtn.disabled = true;
            saveJournalBtn.textContent = 'Saving...';
            
            try {
                // 1. Save the initial entry to Firestore
                const entryData = {
                    userId: currentUser.uid,
                    text: text,
                    createdAt: serverTimestamp(),
                    geminiResponse: null,
                    status: 'processing'
                };
                const docRef = await addDoc(collection(db, "journalEntries"), entryData);
                
                // 2. Clear textarea and update user's journal count
                journalTextarea.value = '';
                await updateUserJournalCount(1);
                
                // 3. Call Gemini API for reflection
                const geminiResponse = await getGeminiReflection(text);
                
                // 4. Update the entry with Gemini's response
                await setDoc(doc(db, "journalEntries", docRef.id), { 
                    geminiResponse: geminiResponse,
                    status: 'complete'
                }, { merge: true });

            } catch (error) {
                console.error("Error saving journal entry: ", error);
                alert("Could not save your entry. Please try again.");
            } finally {
                saveJournalBtn.disabled = false;
                saveJournalBtn.textContent = 'Save & Reflect';
            }
        }

        async function getGeminiReflection(promptText) {
            const payload = {
                contents:
                }],
                systemInstruction: {
                    parts:
                }
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }
                const data = await response.json();
                return data.candidates.content.parts.text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "There was a moment of quiet reflection. Please try again later.";
            }
        }

        function listenForJournalEntries() {
            if (!currentUser) return;
            
            const q = query(collection(db, "journalEntries"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            
            unsubscribeJournalListener = onSnapshot(q, (querySnapshot) => {
                const entries =;
                querySnapshot.forEach((doc) => {
                    entries.push({ id: doc.id,...doc.data() });
                });
                renderJournalHistory(entries);
            }, (error) => {
                console.error("Error listening to journal entries: ", error);
            });
        }
        
        function renderJournalHistory(entries) {
            if (entries.length === 0) {
                journalHistoryContainer.innerHTML = '<p>Your journal entries will appear here.</p>';
                return;
            }
            
            journalHistoryContainer.innerHTML = entries.map(entry => {
                const date = entry.createdAt? entry.createdAt.toDate().toLocaleString() : 'Just now';
                return `
                    <div class="journal-post">
                        <p class="timestamp">${date}</p>
                        <p>${entry.text.replace(/\n/g, '<br>')}</p>
                        <div class="gemini-response ${entry.status}">
                            ${entry.status === 'complete'? entry.geminiResponse : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function updateUserJournalCount(increment) {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const currentCount = userDoc.data().journalEntriesCount |
| 0;
                await setDoc(userRef, { journalEntriesCount: currentCount + increment }, { merge: true });
                loadProfileData(); // Refresh profile data after count update
            }
        }

        // =================================================================================
        // === SOUNDSCAPE MODULE ===========================================================
        // =================================================================================
        
        const volumeSliders = document.querySelectorAll('.volume-slider');
        const masterPlayBtn = document.getElementById('master-play-btn');
        let isPlaying = false;

        volumeSliders.forEach(slider => {
            slider.addEventListener('input', (e) => {
                const audioId = e.target.dataset.audio;
                const audioEl = document.getElementById(audioId);
                audioEl.volume = e.target.value / 100;
            });
        });

        masterPlayBtn.addEventListener('click', () => {
            isPlaying =!isPlaying;
            volumeSliders.forEach(slider => {
                const audioEl = document.getElementById(slider.dataset.audio);
                if (isPlaying) {
                    audioEl.play();
                } else {
                    audioEl.pause();
                }
            });
            masterPlayBtn.textContent = isPlaying? 'Pause Soundscape' : 'Play Soundscape';
        });
        
        // Initial setup on login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                listenForJournalEntries();
            }
        });

    </script>
</body>
</html>