<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="د. عمر العماد - رحلتك نحو الشفاء بالطب الشمولي والوظيفي. أدوات ذكية، جلسات علاجية، ومنتجات طبيعية.">
    <meta name="keywords" content="طب شمولي, طب وظيفي, علاج عن بعد, منتجات طبيعية, شفاء, دكتور عمر العماد, طِبرا, عجلة الحياة, تقييم صحي, DMSO, ترددات شفائية, تشخيص ذكي, خطة علاجية, تحليل الدم, خريطة الجسم, مفكرة الأعراض">
    <title>د. عمر العماد | خبير الطب الشمولي والوظيفي</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- GLOBAL DESIGN SYSTEM & VARIABLES --- */
        :root {
            --primary-color: #5a6e5a;
            --primary-dark: #435243;
            --secondary-color: #f4f1eb;
            --accent-color: #c8a07d;
            --accent-light: #e6d3c1;
            --text-dark: #333333;
            --text-light: #f8f9fa;
        }
        
        /* --- GENERAL BODY & TYPOGRAPHY STYLES --- */
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-dark);
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Kufi Arabic', sans-serif; /* Keep consistent font for headers */
            font-weight: 700;
        }
        .font-brand {
            font-family: 'Great Vibes', cursive;
        }

        /* --- ADVANCED ANIMATIONS & EFFECTS --- */
        @keyframes subtle-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }
        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--accent-light); }
            50% { box-shadow: 0 0 20px var(--accent-light); }
            100% { box-shadow: 0 0 5px var(--accent-light); }
        }
        @keyframes pulse-loader {
          0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(90, 110, 90, 0.7); }
          70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(90, 110, 90, 0); }
          100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(90, 110, 90, 0); }
        }

        /* --- HERO SECTION STYLES --- */
        .hero-bg { animation: subtle-pan 25s ease-in-out infinite; }
        .hero-gradient { background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0.2)); }

        /* --- ENHANCED BUTTON STYLES --- */
        .btn { position: relative; overflow: hidden; transition: all 0.3s ease; transform-style: preserve-3d; }
        .btn-primary { background-color: var(--primary-color); color: var(--text-light); }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-4px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-secondary:hover { background-color: var(--primary-color); color: var(--text-light); transform: translateY(-4px); box-shadow: 0 8px 15px rgba(90, 110, 90, 0.2); }
        .btn-glow { animation: glow 3s infinite ease-in-out; }
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple-effect 0.6s linear; background-color: rgba(255, 255, 255, 0.5); }
        
        /* --- INTERACTIVE DASHBOARD CARD --- */
        .dashboard-card { cursor: pointer; transition: transform 0.4s ease, box-shadow 0.4s ease; transform-style: preserve-3d; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }

        /* --- SECTION STYLES --- */
        .section-title::after { content: ''; display: block; width: 60px; height: 3px; background-color: var(--accent-color); margin: 1rem auto 0; transition: width 0.5s ease; }
        .section-title:hover::after { width: 100px; }
        
        /* --- WHATSAPP & MODAL --- */
        .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 40px; left: 40px; background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 100; transition: transform 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .whatsapp-float:hover { transform: scale(1.1) rotate(10deg); }
        #tool-modal, #quiz-modal { transition: opacity 0.3s ease, backdrop-filter 0.3s ease; backdrop-filter: blur(0px); }
        #tool-modal.is-open, #quiz-modal.is-open { opacity: 1; backdrop-filter: blur(8px); }

        /* --- FADE-IN ANIMATION --- */
        .fade-in-up { opacity: 0; transform: translateY(40px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
        .fade-in-up.is-visible { opacity: 1; transform: translateY(0); }
        
        /* --- AI LOADER --- */
        .ai-loader { text-align: center; }
        .ai-loader .ai-loader-dots { display: inline-block; position: relative; width: 80px; height: 10px; }
        .ai-loader .ai-loader-dots div { position: absolute; top: 0; width: 13px; height: 13px; border-radius: 50%; background-color: var(--primary-color); animation: pulse-loader 1.4s infinite ease-in-out both; }
        .ai-loader .ai-loader-dots .dot1 { left: 8px; animation-delay: -0.32s; }
        .ai-loader .ai-loader-dots .dot2 { left: 32px; animation-delay: -0.16s; }
        .ai-loader .ai-loader-dots .dot3 { left: 56px; }

        /* --- FREQUENCY GENERATOR STYLES --- */
        #frequency-canvas { background-color: #1a1a1a; border-radius: 8px; box-shadow: inset 0 0 10px #000; }
        .freq-btn.active { background-color: var(--accent-color); color: white; transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }

        /* --- SINGLE POST STYLES --- */
        #view-single-post .post-content h2 { font-size: 1.75rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; }
        #view-single-post .post-content p { font-size: 1.1rem; line-height: 1.8; margin-bottom: 1.5rem; }
        #view-single-post .post-content ul { list-style-type: disc; margin-right: 2rem; margin-bottom: 1.5rem; }
        #view-single-post .post-content li { margin-bottom: 0.5rem; }

        /* --- WHEEL OF LIFE --- */
        #wheel-of-life-result { transition: opacity 0.5s ease-in-out; }
        #wheel-of-life-result-container .range-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; border-radius: 4px;
            background: var(--accent-light); outline: none; transition: opacity .2s;
        }
        #wheel-of-life-result-container .range-slider::-webkit-slider-thumb {
             -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
             border-radius: 50%; background: var(--primary-color); cursor: pointer;
        }

        /* --- AUDIO PLAYER --- */
        .audio-player { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.1); }
        #audio-progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; background: var(--accent-light); outline: none; transition: opacity .2s; }
        #audio-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; }
        
        /* --- BODY MAP (NEW) --- */
        #body-map-svg .organ {
            fill: rgba(90, 110, 90, 0.2);
            stroke: var(--primary-dark);
            stroke-width: 1.5;
            transition: fill 0.3s ease, transform 0.3s ease;
            cursor: pointer;
        }
        #body-map-svg .organ:hover {
            fill: rgba(200, 160, 125, 0.7);
            transform: scale(1.05);
        }
        #body-map-info {
             transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* --- JOURNAL (NEW) --- */
        #journal-form label {
            text-align: right;
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .journal-entry {
            border-right: 4px solid var(--accent-light);
        }

        /* --- QUIZZES (NEW) --- */
        .quiz-option {
            transition: background-color 0.2s, border-color 0.2s;
        }
        .quiz-option.selected {
            background-color: var(--accent-light);
            border-color: var(--accent-color);
        }
    </style>
</head>
<body class="bg-secondary-color text-text-dark">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-lg sticky top-0 z-50 transition-shadow duration-300">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="font-brand text-4xl text-gray-800 nav-link" data-view="hero">د. عمر العماد</a>
            <div class="hidden md:flex items-center space-x-reverse space-x-6">
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="about">عني</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="dashboard">الخدمات التفاعلية</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="services">الجلسات</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="store">المتجر</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="blog">المدونة</a>
                 <!-- Login/Profile Link -->
                 <div id="auth-section" class="flex items-center">
                     <button id="login-btn" class="font-bold text-[--primary-color] hover:underline">تسجيل الدخول</button>
                     <div id="profile-section-nav" class="hidden items-center">
                         <a href="#" class="nav-link font-bold text-[--primary-color] hover:underline ml-4" data-view="premium-content">ملف المريض</a>
                         <img id="user-avatar" class="w-8 h-8 rounded-full" alt="صورة المستخدم" onerror="this.src='https://placehold.co/40x40/5a6e5a/white?text=U'">
                     </div>
                 </div>
            </div>
            <a href="#contact" class="hidden md:block btn btn-primary text-white py-2 px-6 rounded-full">احجز جلستك</a>
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </nav>
          <!-- Mobile Menu -->
          <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
               <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="about">عني</a>
               <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="dashboard">الخدمات التفاعلية</a>
               <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="services">الجلسات</a>
               <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="store">المتجر</a>
               <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="blog">المدونة</a>
               <a href="#contact" class="block py-2 hover:text-[--primary-color]">تواصل معي</a>
               <hr class="my-2">
               <div id="auth-section-mobile">
                   <button id="login-btn-mobile" class="w-full text-right py-2 font-bold text-[--primary-color]">تسجيل الدخول</button>
                   <a href="#" id="profile-link-mobile" class="nav-link hidden w-full text-right py-2 font-bold text-[--primary-color]" data-view="premium-content">ملف المريض</a>
               </div>
          </div>
    </header>

    <main id="main-content">
        <!-- Hero Section -->
        <section id="view-hero" class="page-view relative h-screen flex items-center justify-center text-white text-center">
            <div class="absolute inset-0 bg-cover bg-center hero-bg" style="background-image: url('https://images.unsplash.com/photo-1542601906-8b6aBA801697?q=80&w=2070&auto=format&fit=crop');"></div>
            <div class="absolute inset-0 hero-gradient"></div>
            <div class="relative z-10 p-6 fade-in-up">
                <h1 class="font-brand text-7xl md:text-9xl mb-4">ṬibraSoul</h1>
                <h2 class="text-2xl md:text-4xl font-bold mb-2">رحلتك نحو الشفاء المتكامل تبدأ هنا</h2>
                <p class="text-lg md:text-xl max-w-3xl mx-auto">أساعدك على استعادة توازن جسدك وروحك عبر دمج حكمة الطب الشمولي والوظيفي مع أحدث العلوم.</p>
                <a href="#" class="nav-link mt-8 inline-block btn bg-white text-[--primary-color] font-bold py-3 px-8 rounded-full text-lg btn-glow" data-view="dashboard">اكتشف خدماتنا</a>
            </div>
        </section>

        <!-- Interactive Dashboard Section -->
        <section id="view-dashboard" class="page-view py-20 bg-gray-50 hidden">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 section-title">لوحة التحكم التفاعلية</h2>
                <p class="max-w-3xl mx-auto mb-12">اختر الأداة أو الخدمة التي تناسب احتياجك الحالي وابدأ رحلة الشفاء.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Card 1: AI Tools -->
                    <div class="p-8 rounded-xl shadow-lg dashboard-card text-center md:col-span-2">
                        <div class="text-5xl text-[--primary-color] mb-4"><i class="fas fa-magic-wand-sparkles"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الأدوات الذكية</h3>
                        <p class="text-gray-600 mb-6">استخدم أدوات الذكاء الاصطناعي للتشخيص، إنشاء الخطط العلاجية، الحصول على توصيات، والمزيد.</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="blood-test-decoder">فك شفرة التحاليل</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="diagnosis">التشخيص</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="treatment-plan">خطة علاجية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="supplements">توصية مكملات</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="awareness-exercise">تمرين وعي</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="consultation">استشارة آلية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="intention">نية اليوم</button>
                        </div>
                    </div>

                    <!-- Card 2: Wheel of Life -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="wheel-of-life">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-dharmachakra"></i></div>
                        <h3 class="text-2xl font-bold mb-3">عجلة العافية</h3>
                        <p class="text-gray-600">قيّم جوانب حياتك المختلفة واحصل على رؤى فورية لتحقيق التوازن.</p>
                    </a>
                    
                    <!-- NEW Card: Body Map -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="body-map">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-person-chalkboard"></i></div>
                        <h3 class="text-2xl font-bold mb-3">خريطة الجسم التفاعلية</h3>
                        <p class="text-gray-600">استكشف أعضاء جسدك وافهم رسائلها من منظور شمولي.</p>
                    </a>

                    <!-- NEW Card: Symptom Journal -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="journal">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-book-medical"></i></div>
                        <h3 class="text-2xl font-bold mb-3">مفكرة الأعراض والمزاج</h3>
                        <p class="text-gray-600">تتبع صحتك اليومية واكتشف الأنماط الخفية (للمسجلين فقط).</p>
                    </a>

                    <!-- NEW Card: Quizzes -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="quizzes">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-clipboard-question"></i></div>
                        <h3 class="text-2xl font-bold mb-3">التقييمات الصحية</h3>
                        <p class="text-gray-600">أجب عن استبيانات دقيقة لتقييم جوانب محددة من صحتك.</p>
                    </a>

                    <!-- Original Cards -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="services">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-user-doctor"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الجلسات الاستشارية</h3>
                        <p class="text-gray-600">احجز جلسة استشارية شاملة أو جلسة متابعة معي مباشرة.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="frequencies">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-wave-square"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الترددات الشفائية</h3>
                        <p class="text-gray-600">استمع إلى ترددات السولفيجيو المصممة لتهدئة الجهاز العصبي.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="store">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-store"></i></div>
                        <h3 class="text-2xl font-bold mb-3">المتجر العلاجي</h3>
                        <p class="text-gray-600">تصفح المكملات الغذائية والمنتجات الطبيعية التي أوصي بها.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="blog">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-book-open"></i></div>
                        <h3 class="text-2xl font-bold mb-3">المقالات والمعرفة</h3>
                        <p class="text-gray-600">اقرأ أحدث المقالات والرؤى حول الطب الشمولي.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="premium-content">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-folder-user"></i></div>
                        <h3 class="text-2xl font-bold mb-3">ملف المريض</h3>
                        <p class="text-gray-600">ادخل إلى مساحتك الخاصة لمراجعة نتائجك المحفوظة.</p>
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Wheel of Life Section -->
        <section id="view-wheel-of-life" class="page-view py-20 bg-white hidden">
             <div class="container mx-auto px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold mb-4 section-title">عجلة العافية الشمولية</h2>
                    <p class="max-w-3xl mx-auto text-lg">قيّم مستوى رضاك في الجوانب الأساسية لحياتك. حرك المؤشرات لتعكس وضعك الحالي، ثم احصل على رؤى فورية لمساعدتك على تحديد نقاط التركيز في رحلتك نحو التوازن.</p>
                </div>

                <div id="wheel-of-life-result-container" class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <!-- Chart Canvas -->
                    <div class="w-full max-w-lg mx-auto fade-in-up">
                        <canvas id="wheel-of-life-chart"></canvas>
                    </div>
                    <!-- Sliders -->
                    <div id="wheel-of-life-sliders" class="space-y-4 fade-in-up" style="animation-delay: 0.2s;">
                        <!-- Sliders will be dynamically generated here -->
                    </div>
                </div>

                <!-- Result Section -->
                <div class="mt-12 text-center">
                     <button id="get-wheel-insight-btn" class="btn btn-primary text-white py-3 px-8 text-lg rounded-full">اكشف عن رؤيتك الشخصية</button>
                     <div id="wheel-of-life-result" class="mt-6 p-6 bg-green-50 border-r-4 border-primary-color rounded-lg max-w-4xl mx-auto opacity-0 hidden">
                         <!-- AI Insight will be injected here -->
                     </div>
                </div>
            </div>
        </section>

        <!-- About Me Section -->
        <section id="view-about" class="page-view py-20 bg-white hidden">
             <div class="container mx-auto px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="md:flex items-center gap-12">
                    <div class="md:w-1/3 text-center fade-in-up">
                        <img src="https://i.ibb.co/6wmT73L/image-c28027.jpg" alt="صورة د. عمر العماد" class="rounded-full shadow-2xl mx-auto w-64 h-64 md:w-80 md:h-80 object-cover border-4 border-white" onerror="this.onerror=null;this.src='https://placehold.co/320x320/eeeeee/333333?text=Dr.+Omar';">
                    </div>
                    <div class="md:w-2/3 mt-8 md:mt-0 fade-in-up">
                        <h2 class="text-4xl font-bold mb-4 section-title text-right">عن د. عمر العماد</h2>
                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-4">طبيبك ومرشدك في رحلة الشفاء</h3>
                        <p class="mb-4">أنا طبيب متخصص في الطب الشمولي والوظيفي، أؤمن بأن الشفاء الحقيقي ينبع من معالجة الأسباب الجذرية للمرض، وليس فقط أعراضه. من خلال خبرتي، أجمع بين الطب الحديث، التغذية العلاجية، وتقنيات إدارة الضغط النفسي لمساعدتك على تحقيق صحة مثالية.</p>
                        <p class="font-semibold">هدفي هو تمكينك بالمعرفة والأدوات اللازمة لتصبح أنت طبيب نفسك، وتعيش حياة مليئة بالحيوية والسكينة.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Services Section -->
        <section id="view-services" class="page-view py-20 hidden">
             <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">جلسات العلاج الشمولي</h2>
                <p class="max-w-2xl mx-auto mb-12">جلسات شخصية عن بعد، مصممة خصيصاً لتلبية احتياجاتك الفريدة ومساعدتك على تحقيق أهدافك الصحية.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-user-md"></i></div>
                        <h3 class="text-2xl font-bold mb-3">استشارة أولية شاملة</h3>
                        <p class="mb-6">جلسة لمدة 90 دقيقة لتقييم حالتك الصحية بالكامل، مناقشة تاريخك المرضي، ووضع خريطة طريق علاجية مخصصة.</p>
                        <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20أولية%20شاملة" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">احجز الآن</a>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-heartbeat"></i></div>
                        <h3 class="text-2xl font-bold mb-3">باقة المتابعة الصحية</h3>
                        <p class="mb-6">3 جلسات متابعة (45 دقيقة لكل جلسة) لمراقبة تقدمك، تعديل الخطة العلاجية، وتقديم الدعم المستمر لك.</p>
                         <a href="https://wa.me/967771447111?text=أرغب%20في%20الاشتراك%20بباقة%20المتابعة%20الصحية" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">اشترك الآن</a>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.4s;">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-leaf"></i></div>
                        <h3 class="text-2xl font-bold mb-3">استشارة التغذية الوظيفية</h3>
                        <p class="mb-6">جلسة مركزة لمدة 60 دقيقة لوضع خطة تغذية علاجية مخصصة لمعالجة مشاكل صحية معينة مثل مشاكل الهضم أو الطاقة.</p>
                         <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20التغذية%20الوظيفية" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">احجز الآن</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Store Section -->
        <section id="view-store" class="page-view py-20 bg-gray-50 hidden">
            <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">متجر المنتجات الشافية</h2>
                <p class="max-w-2xl mx-auto mb-12">مجموعة منتقاة بعناية من المنتجات الطبيعية والأدوية الوظيفية التي أثق بها وأوصي بها لدعم رحلتك العلاجية.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <img src="https://placehold.co/300x300/5a6e5a/white?text=DMSO" alt="DMSO" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">DMSO للجلد</h3>
                            <p class="text-gray-600 mb-4">مذيب طبيعي قوي لدعم الشفاء وتخفيف الألم الموضعي.</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">$45</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20DMSO%20للجلد" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.1s;">
                        <img src="https://placehold.co/300x300/c8a07d/white?text=Vit+D3" alt="مكمل فيتامين د3 + ك2" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">مكمل فيتامين د3 + ك2</h3>
                            <p class="text-gray-600 mb-4">لدعم صحة العظام والمناعة.</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">$35</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20مكمل%20فيتامين%20د3%20%2B%20ك2" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <img src="https://placehold.co/300x300/5a6e5a/white?text=Mg+Oil" alt="زيت الماغنسيوم النقي" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">زيت الماغنسيوم النقي</h3>
                            <p class="text-gray-600 mb-4">للاسترخاء وتخفيف آلام العضلات.</p>
                             <p class="text-2xl font-bold text-[--primary-color] mb-4">$25</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20زيت%20الماغنسيوم%20النقي" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.3s;">
                        <img src="https://placehold.co/300x300/c8a07d/white?text=Probiotic" alt="بروبيوتيك عالي الجودة" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">بروبيوتيك عالي الجودة</h3>
                            <p class="text-gray-600 mb-4">لدعم صحة الجهاز الهضمي والميكروبيوم.</p>
                             <p class="text-2xl font-bold text-[--primary-color] mb-4">$50</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20بروبيوتيك%20عالي%20الجودة" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Frequency Generator Section -->
        <section id="view-frequencies" class="page-view py-20 bg-white hidden">
            <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">مولد الترددات الشفائية</h2>
                <p class="max-w-2xl mx-auto mb-12">اختر أحد ترددات السولفيجيو للاستماع إليها أثناء التأمل. استخدم سماعات الرأس لأفضل تأثير.</p>
                <div class="bg-gray-100 p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <canvas id="frequency-canvas" class="w-full h-32 mb-8"></canvas>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="frequency-buttons">
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="396">396 Hz - تحرير الذنب والخوف</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="417">417 Hz - تسهيل التغيير</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="528">528 Hz - التحول والمعجزات</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="639">639 Hz - إعادة الاتصال والعلاقات</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="741">741 Hz - إيقاظ الحدس</button>
                        <button class="freq-btn p-4 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="852">852 Hz - العودة إلى النظام الروحي</button>
                    </div>
                    <button id="stop-freq-btn" class="mt-8 btn btn-secondary py-2 px-6 rounded-full hidden">إيقاف التردد</button>
                </div>
            </div>
        </section>

        <!-- Body Map Section (NEW) -->
        <section id="view-body-map" class="page-view py-20 bg-white hidden">
            <div class="container mx-auto px-6">
                <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold mb-4 section-title">خريطة الجسم التفاعلية</h2>
                    <p class="max-w-3xl mx-auto text-lg">انقر على أي عضو في الرسم التوضيحي لاستكشاف وظيفته من منظور شمولي، الأعراض المرتبطة به، وكيفية دعمه لتحقيق الشفاء.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                    <!-- Body Map SVG -->
                    <div class="md:col-span-1 flex justify-center items-center">
                        <svg id="body-map-svg" viewBox="0 0 200 400" xmlns="http://www.w3.org/2000/svg" class="w-full max-w-xs h-auto">
                            <!-- Head/Brain -->
                            <path class="organ" data-organ="brain" d="M100,50 a40,40 0 1,0 0.1,0 Z" />
                            <text x="100" y="55" text-anchor="middle" font-size="10" fill="#333">الدماغ</text>
                            <!-- Thyroid -->
                            <path class="organ" data-organ="thyroid" d="M85,95 a15,8 0 0,0 30,0 Z" />
                            <text x="100" y="100" text-anchor="middle" font-size="8" fill="#333">الغدة الدرقية</text>
                             <!-- Heart -->
                            <path class="organ" data-organ="heart" d="M100 130 C 90 120, 70 125, 75 145 S 100 160, 100 160 S 125 145, 125 145 S 110 120, 100 130 Z" />
                             <!-- Liver -->
                            <path class="organ" data-organ="liver" d="M105,170 C 130,170 140,190 130,210 L 80,210 C 70,190 80,170 105,170 Z" />
                            <text x="110" y="195" text-anchor="middle" font-size="10" fill="#333">الكبد</text>
                            <!-- Gut/Intestines -->
                            <path class="organ" data-organ="gut" d="M80,220 C 75,260 125,260 120,220 C 120,220 110,230 100,230 C 90,230 80,220 80,220 Z M85,240 C 85,255 115,255 115,240 C 110,245 90,245 85,240 Z" />
                            <text x="100" y="245" text-anchor="middle" font-size="10" fill="#333">الأمعاء</text>
                             <!-- Adrenals -->
                            <path class="organ" data-organ="adrenals" d="M80,180 a10,5 0 0,1 15,0" />
                            <path class="organ" data-organ="adrenals" d="M105,180 a10,5 0 0,1 15,0" />
                        </svg>
                    </div>

                    <!-- Info Panel -->
                    <div id="body-map-info-container" class="md:col-span-2">
                        <div id="body-map-info" class="bg-white p-8 rounded-xl shadow-lg opacity-0 transform translate-y-5">
                            <h3 id="organ-name" class="text-3xl font-bold mb-4 text-[--primary-color]">حدد عضواً للبدء</h3>
                            <div id="organ-details">
                                <p class="text-gray-600">انقر على رسم الجسم لاكتشاف المزيد.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Quizzes Section (NEW) -->
        <section id="view-quizzes" class="page-view py-20 bg-gray-50 hidden">
             <div class="container mx-auto px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold mb-4 section-title">التقييمات الصحية التفاعلية</h2>
                    <p class="max-w-3xl mx-auto text-lg">هذه الاستبيانات ليست تشخيصاً طبياً، بل هي أدوات لمساعدتك على زيادة وعيك بصحتك وتحديد المجالات التي قد تحتاج إلى اهتمام. ناقش النتائج دائماً مع مختص.</p>
                </div>
                
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">اختبار الإرهاق الكظري</h3>
                        <p class="text-gray-600 mb-4">هل تشعر بالتعب المستمر وصعوبة في التعامل مع الإجهاد؟ قد تكون غدتك الكظرية بحاجة إلى دعم.</p>
                        <button class="btn btn-primary text-white py-2 px-6 rounded-full quiz-start-btn" data-quiz="adrenal-fatigue">ابدأ الاختبار</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">تقييم الأمعاء المتسربة</h3>
                        <p class="text-gray-600 mb-4">اكتشف ما إذا كانت مشاكل مثل الانتفاخ، الحساسية الغذائية، أو المشاكل الجلدية قد تكون مرتبطة بصحة أمعائك.</p>
                        <button class="btn btn-secondary py-2 px-6 rounded-full" disabled>قريباً...</button>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">احسب درجة السمية في جسمك</h3>
                        <p class="text-gray-600 mb-4">قيّم تعرضك للسموم البيئية وقدرة جسمك على التخلص منها.</p>
                        <button class="btn btn-secondary py-2 px-6 rounded-full" disabled>قريباً...</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Journal Section (NEW) -->
        <section id="view-journal" class="page-view py-20 bg-white hidden">
            <div class="container mx-auto px-6">
                <div id="journal-content-container">
                     <div class="text-right mb-12">
                         <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                             <i class="fas fa-arrow-right-long ml-2"></i>
                             الرجوع إلى لوحة التحكم
                          </button>
                     </div>
                    <div class="text-center mb-12">
                        <h2 class="text-4xl font-bold mb-4 section-title">مفكرة الأعراض والمزاج</h2>
                        <p class="max-w-3xl mx-auto text-lg">أداة قوية لتصبح محققاً في رحلتك الصحية. سجّل تتبعك اليومي هنا لاكتشاف الروابط بين نمط حياتك وما تشعر به.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- New Entry Form -->
                        <div class="md:col-span-1 bg-gray-50 p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-center">إدخال اليوم</h3>
                            <form id="journal-form">
                                <div class="mb-4">
                                    <label for="entry-date">التاريخ</label>
                                    <input type="date" id="entry-date" class="w-full p-2 border rounded-md" required>
                                </div>
                                <div class="mb-4">
                                    <label for="mood-rating">المزاج (1=سيء, 10=ممتاز)</label>
                                    <input type="range" id="mood-rating" min="1" max="10" value="5" class="w-full">
                                </div>
                                 <div class="mb-4">
                                    <label for="energy-rating">الطاقة (1=منهك, 10=حيوي)</label>
                                    <input type="range" id="energy-rating" min="1" max="10" value="5" class="w-full">
                                </div>
                                 <div class="mb-4">
                                    <label for="sleep-quality">جودة النوم (ساعات)</label>
                                    <input type="number" id="sleep-quality" min="0" max="12" step="0.5" class="w-full p-2 border rounded-md" placeholder="e.g., 7.5">
                                </div>
                                 <div class="mb-4">
                                    <label for="symptoms-today">الأعراض اليوم</label>
                                    <textarea id="symptoms-today" rows="3" class="w-full p-2 border rounded-md" placeholder="صداع، انتفاخ، ألم مفاصل..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary text-white w-full py-3 rounded-full">حفظ الإدخال</button>
                            </form>
                        </div>
                        <!-- Entries & Charts -->
                        <div class="md:col-span-2">
                             <h3 class="text-2xl font-bold mb-4 text-center">تحليل الأنماط</h3>
                             <div class="bg-gray-50 p-6 rounded-xl shadow-lg mb-6">
                                 <canvas id="journal-chart"></canvas>
                             </div>
                             <h3 class="text-2xl font-bold mb-4 text-center">سجل إدخالاتي</h3>
                             <div id="journal-entries-container" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                 <!-- Entries will be loaded here -->
                             </div>
                        </div>
                    </div>
                </div>

                 <div id="journal-login-prompt" class="hidden text-center py-16">
                     <div class="bg-white max-w-2xl mx-auto p-8 rounded-xl shadow-lg">
                         <i class="fas fa-lock text-5xl text-[--accent-color] mb-4"></i>
                         <h3 class="text-2xl font-bold mb-3">هذه الميزة حصرية للأعضاء</h3>
                         <p class="text-gray-600 mb-6">يرجى تسجيل الدخول للوصول إلى مفكرة الأعراض والمزاج الخاصة بك وحفظ تقدمك.</p>
                         <button id="login-for-journal-btn" class="btn btn-primary text-white py-2 px-8 rounded-full">تسجيل الدخول</button>
                     </div>
                 </div>
            </div>
        </section>
        
        <!-- Premium Content / Patient File Section -->
        <section id="view-premium-content" class="page-view py-20 hidden">
            <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 id="welcome-message" class="text-4xl font-bold mb-4 section-title">مرحباً بك في أسرتنا</h2>
                <p class="max-w-2xl mx-auto mb-12">هذه مساحتك الحصرية. هنا ستجد المحتوى الخاص وجميع نتائجك المحفوظة من أدواتنا الذكية.</p>
                <div id="patient-file-content" class="bg-white p-8 rounded-xl shadow-inner max-w-4xl mx-auto text-right">
                    <h3 class="text-2xl font-bold mb-6">سجلاتي المحفوظة</h3>
                    <div id="saved-results-container" class="space-y-6">
                        <p>الرجاء تسجيل الدخول لعرض سجلاتك المحفوظة.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Blog Section -->
        <section id="view-blog" class="page-view py-20 bg-gray-50 hidden">
             <div class="container mx-auto px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="text-4xl font-bold mb-4 section-title">من وحي المدونة</h2>
                <p class="max-w-2xl mx-auto mb-12">مقالات ورؤى لمساعدتك على فهم جسدك بشكل أفضل واتخاذ قرارات صحية مستنيرة.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 text-right">
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <img src="https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070&auto=format&fit=crop" alt="صورة طعام صحي" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-3">هل أمعاؤك هي سبب تقلبات مزاجك؟</h3>
                            <p class="text-gray-600 mb-4">اكتشف العلاقة المدهشة بين صحة الجهاز الهضمي وصحتك النفسية.</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="gut-brain">اقرأ المزيد &larr;</a>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <img src="https://images.unsplash.com/photo-1599301934984-1d2741913a5f?q=80&w=2070&auto=format&fit=crop" alt="صورة امرأة تتأمل" class="w-full h-56 object-cover">
                        <div class="p-6">
                             <h3 class="text-xl font-bold mb-3">قوة التنفس: كيف تهدئ جهازك العصبي في 5 دقائق</h3>
                            <p class="text-gray-600 mb-4">تعلم تقنية تنفس بسيطة وفعالة لخفض التوتر والقلق فوراً.</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="breathing">اقرأ المزيد &larr;</a>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.4s;">
                        <img src="https://images.unsplash.com/photo-1476837579993-f1d3948f17c2?q=80&w=2070&auto=format&fit=crop" alt="صورة توابل وأعشاب" class="w-full h-56 object-cover">
                        <div class="p-6">
                           <h3 class="text-xl font-bold mb-3">أفضل 3 مكملات غذائية لمكافحة الالتهابات</h3>
                            <p class="text-gray-600 mb-4">دليلي لاختيار المكملات الأكثر فعالية لدعم صحتك العامة.</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="supplements">اقرأ المزيد &larr;</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Single Post View -->
        <section id="view-single-post" class="page-view py-20 bg-white hidden">
            <div class="container mx-auto px-6 max-w-4xl">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="blog">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى المدونة
                     </button>
                 </div>
                 <article>
                     <h1 id="post-title" class="text-4xl md:text-5xl font-bold mb-4 text-center section-title"></h1>
                     <img id="post-image" src="" alt="صورة المقال" class="w-full h-96 object-cover rounded-xl shadow-lg my-8">
                     <div id="post-content" class="prose lg:prose-xl max-w-none text-right"></div>
                 </article>
            </div>
        </section>
        
        <!-- Mindfulness Moment Section -->
        <section class="py-20 bg-gray-50">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 section-title">لحظة هدوء</h2>
                <p class="max-w-2xl mx-auto mb-8 text-lg">خذ دقيقة من يومك لإعادة شحن طاقتك وتهدئة جهازك العصبي مع هذا التمرين التنفسي الموجه.</p>
                <div class="max-w-md mx-auto fade-in-up">
                    <div class="audio-player">
                         <div class="flex items-center">
                             <button id="audio-play-pause-btn" class="text-4xl text-[--primary-color] hover:text-[--primary-dark] transition-colors">
                                 <i class="fas fa-play-circle"></i>
                             </button>
                             <div class="flex-grow mx-4 text-right">
                                 <div class="font-bold text-lg text-text-dark">تمرين التنفس العميق</div>
                                 <div id="audio-time" class="text-sm text-gray-600">00:00 / 01:00</div>
                                 <input type="range" id="audio-progress-bar" value="0" step="1" class="w-full mt-2">
                             </div>
                         </div>
                    </div>
                    <audio id="guided-audio" src="https://firebasestorage.googleapis.com/v0/b/tibrasoul.appspot.com/o/audio%2F1-minute-breathing-meditation.mp3?alt=media&token=48734898-1e43-4158-b7a4-9dfc120336b1"></audio>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Footer -->
    <footer id="contact" class="bg-gray-800 text-white pt-20 pb-8">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-4">هل أنت مستعد لبدء رحلة الشفاء؟</h2>
            <p class="max-w-xl mx-auto mb-8">تواصل معي اليوم عبر واتساب لحجز استشارتك الأولى، أو تابعني على وسائل التواصل الاجتماعي لمحتوى يومي ملهم.</p>
            <a href="https://wa.me/967771447111?text=أهلاً%20د.%20عمر،%20أرغب%20في%20الاستفسار%20عن%20جلسات%20العلاج%20الشمولي" target="_blank" class="btn btn-primary text-white text-xl py-3 px-8 rounded-full inline-block mb-12"><i class="fab fa-whatsapp"></i> تواصل معي عبر واتساب</a>
            
            <div class="flex justify-center space-x-6 text-3xl mb-8">
                <a href="https://www.instagram.com/dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.tiktok.com/@dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-tiktok"></i></a>
            </div>

            <div class="border-t border-gray-700 pt-6">
                 <p>&copy; 2025 د. عمر العماد | جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/967771447111" class="whatsapp-float" target="_blank" aria-label="تواصل معنا عبر واتساب">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Modals -->
    <div id="tool-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 opacity-0">
        <div id="modal-content" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300"></div>
    </div>
    
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 opacity-0">
        <div id="quiz-modal-content" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300"></div>
    </div>


    <!-- Notification Toast -->
    <div id="notification-toast" class="hidden fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-transform duration-500 translate-x-full">
        <p id="notification-message" class="text-white"></p>
    </div>
    
    <script type="module">
        // --- SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        // The firebaseConfig is now loaded from the environment for security and portability.
        // A fallback is provided from the original code to ensure functionality.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
          ? JSON.parse(__firebase_config)
          : {
              apiKey: "AIzaSyBi2y64T-X1FNwbhv8ATQnF5xTZ3Pq4neg",
              authDomain: "tibrasoul.firebaseapp.com",
              projectId: "tibrasoul",
              storageBucket: "tibrasoul.appspot.com",
              messagingSenderId: "920755760709",
              appId: "1:920755760709:web:778cd12e6edbd199827d2c"
          };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let wheelChart;
        let journalChart; 

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            initSmartTools();
            initFrequencyGenerator();
            initGeneralUI();
            initNavigation();
            initCreativeEffects();
            initBlog();
            initWheelOfLife();
            initAudioPlayer();
            initBodyMap(); 
            initQuizzes(); 
            initJournal(); 
            showView('hero');
        });

        // --- NAVIGATION MODULE ---
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.dataset.view;
                    if (viewName) {
                        document.getElementById('mobile-menu').classList.add('hidden');
                        showView(viewName);
                    }
                });
            });
        }

        function showView(viewId) {
             document.querySelectorAll('.page-view').forEach(view => {
                view.classList.add('hidden');
             });
             const targetView = document.getElementById('view-' + viewId);
             if(targetView) {
                 targetView.classList.remove('hidden');
                 window.scrollTo(0, 0);
                 const elementsToAnimate = targetView.querySelectorAll('.fade-in-up');
                 // Reset animation for re-triggering
                 elementsToAnimate.forEach(el => el.classList.remove('is-visible'));
                 // Trigger animation
                 setTimeout(() => {
                    elementsToAnimate.forEach(el => {
                         el.classList.add('is-visible');
                    });
                 }, 100);
             }
        }

        // --- NOTIFICATION MODULE ---
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        let notificationTimeout;
        function showNotification(message, type = 'error', duration = 4000) {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            // Reset classes
            notificationToast.className = 'fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-all duration-500 transform text-white';
            if (type === 'success') {
                notificationToast.classList.add('bg-green-500');
            } else if (type === 'warning') {
                notificationToast.classList.add('bg-yellow-500');
            } else {
                notificationToast.classList.add('bg-red-600');
            }
            notificationToast.classList.remove('hidden');
            notificationToast.classList.add('translate-x-full'); // Start off-screen
            setTimeout(() => {
                notificationToast.classList.remove('translate-x-full'); // Slide in
            }, 10);
            notificationTimeout = setTimeout(() => {
                notificationToast.classList.add('translate-x-full'); // Slide out
                 setTimeout(() => notificationToast.classList.add('hidden'), 500);
            }, duration);
        }

        // --- AUTHENTICATION MODULE ---
        function initAuth() {
            const loginBtns = [
                document.getElementById('login-btn'), 
                document.getElementById('login-btn-mobile'),
                document.getElementById('login-for-journal-btn')
            ];
            
            onAuthStateChanged(auth, user => {
                currentUser = user;
                const isLoggedIn = !!user;
                
                document.getElementById('login-btn').classList.toggle('hidden', isLoggedIn);
                document.getElementById('login-btn-mobile').classList.toggle('hidden', isLoggedIn);
                document.getElementById('profile-section-nav').classList.toggle('hidden', !isLoggedIn);
                document.getElementById('profile-section-nav').classList.toggle('flex', isLoggedIn);
                document.getElementById('profile-link-mobile').classList.toggle('hidden', !isLoggedIn);

                if (isLoggedIn) {
                    document.getElementById('user-avatar').src = user.photoURL || 'https://placehold.co/40x40/5a6e5a/white?text=U';
                    document.getElementById('welcome-message').textContent = `مرحباً بك في أسرتنا، ${user.displayName || 'صديقي'}`;
                    loadPatientFileData();
                    toggleJournalView(true);
                    loadJournalEntries(); 
                } else {
                    document.getElementById('saved-results-container').innerHTML = '<p>الرجاء تسجيل الدخول لعرض سجلاتك المحفوظة.</p>';
                    toggleJournalView(false);
                }
            });

            const handleLogin = () => {
                signInWithPopup(auth, provider).catch(error => {
                    console.error("Google Login Error:", error);
                    showNotification("فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.", "error");
                });
            }
            loginBtns.forEach(btn => {
                if(btn) btn.addEventListener('click', handleLogin)
            });
        }
        
        // --- FIRESTORE MODULE ---
        async function saveResultToFirestore(toolName, resultData) {
            if (!currentUser) {
                showNotification('الرجاء تسجيل الدخول لحفظ نتائجك.', 'warning'); 
                return;
            }
            const resultId = `${toolName.replace(/\s+/g, '-')}-${new Date().getTime()}`;
            const resultRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'toolResults', resultId);
            
            try {
                await setDoc(resultRef, {
                    tool: toolName,
                    data: resultData,
                    createdAt: new Date()
                });
                const saveBtn = document.getElementById('save-result-btn') || document.getElementById('save-wheel-result-btn');
                if(saveBtn) {
                   saveBtn.textContent = 'تم الحفظ بنجاح!';
                   saveBtn.disabled = true;
                }
                showNotification('تم حفظ النتيجة بنجاح في ملفك!', 'success');
                loadPatientFileData();
            } catch (error) {
                console.error("Error saving document: ", error);
                showNotification('حدث خطأ أثناء حفظ النتيجة.', 'error');
            }
        }

        async function loadPatientFileData() {
            if (!currentUser) return;
            const container = document.getElementById('saved-results-container');
            container.innerHTML = '<p>جاري تحميل سجلاتك...</p>';
            try {
                const resultsCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'toolResults');
                const q = query(resultsCol, orderBy("createdAt", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p>لا توجد نتائج محفوظة بعد. استخدم إحدى الأدوات الذكية واحفظ النتيجة لتظهر هنا.</p>';
                    return;
                }
                let html = '';
                querySnapshot.forEach(doc => {
                    const result = doc.data();
                    html += `
                        <div class="p-4 bg-gray-50 border-r-4 border-gray-300 rounded-md">
                            <h4 class="font-bold text-lg">${result.tool}</h4>
                            <p class="text-sm text-gray-500 mb-2">تاريخ الحفظ: ${result.createdAt.toDate().toLocaleString('ar-EG')}</p>
                            <div class="text-gray-700 whitespace-pre-wrap">${result.data}</div>
                        </div>`;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error("Error loading patient data:", error);
                container.innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل سجلاتك. يرجى المحاولة مرة أخرى.</p>';
            }
        }

        // --- SMART TOOLS MODULE ---
        function initSmartTools() {
            const toolModal = document.getElementById('tool-modal');
            const modalContent = document.getElementById('modal-content');
            
            const showModal = (content) => {
                modalContent.innerHTML = content;
                toolModal.classList.remove('hidden');
                setTimeout(() => {
                    toolModal.classList.add('is-open');
                    modalContent.parentElement.classList.add('scale-100');
                }, 10);
                const closeButton = modalContent.querySelector('.close-modal-btn');
                if (closeButton) closeButton.addEventListener('click', hideModal);
            };

            const hideModal = () => {
                toolModal.classList.remove('is-open');
                modalContent.parentElement.classList.remove('scale-100');
                setTimeout(() => {
                    toolModal.classList.add('hidden');
                    modalContent.innerHTML = '';
                }, 300);
            };
            
            toolModal.addEventListener('click', e => {
                if (e.target === toolModal) hideModal();
            });

            document.querySelectorAll('.smart-tool-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tool = button.dataset.tool;
                    let modalHTML = '';
                    switch(tool) {
                         case 'blood-test-decoder':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">فك شفرة تحاليل الدم</h3>
                                 <p class="text-gray-600 mb-6">الصق نتائج تحاليل دمك هنا. ستقوم الأداة بتحليلها من منظور الطب الوظيفي، مع التركيز على المعدلات المثالية وليس فقط الطبيعية.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="blood-test-data" class="block text-right font-semibold mb-2">نتائج التحليل</label>
                                         <textarea id="blood-test-data" rows="10" class="w-full p-2 border rounded-md" placeholder="مثال:&#10;Vitamin D (25-OH) ..... 21 ng/mL&#10;Ferritin ................ 35 ng/mL&#10;TSH ..................... 3.8 mIU/L"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">حلل نتائجي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'diagnosis':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تشخيص متعدد الأبعاد</h3>
                                 <p class="text-gray-600 mb-6">يرجى إدخال المعلومات التالية بأكبر قدر ممكن من التفصيل.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="symptoms" class="block text-right font-semibold mb-2">1. الأعراض الجسدية</label>
                                         <textarea id="symptoms" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: صداع نصفي، ألم في المفاصل..."></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="feelings" class="block text-right font-semibold mb-2">2. المشاعر والأفكار</label>
                                         <textarea id="feelings" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: أشعر بقلق دائم، أفكار سلبية..."></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="lifestyle" class="block text-right font-semibold mb-2">3. نمط الحياة</label>
                                         <textarea id="lifestyle" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: نومي متقطع، أعتمد على الوجبات السريعة..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">ابدأ التحليل</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'treatment-plan':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">وصفة علاجية شمولية ذكية</h3>
                                 <p class="text-gray-600 mb-6">أدخل التشخيص أو الأعراض الرئيسية، مع معلومات إضافية، للحصول على خطة علاجية مقترحة.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="diagnosis-input" class="block text-right font-semibold mb-2">1. التشخيص أو الأعراض الرئيسية</label>
                                         <textarea id="diagnosis-input" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: تشخيص بالقولون العصبي، مع قلق وتعب مستمر"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">صمم خطتي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'awareness-exercise':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تمرين وعي موجّه</h3>
                                 <p class="text-gray-600 mb-6">صف المشاعر التي تمر بها أو الصدمة التي تود العمل عليها، وسيقوم المساعد الذكي بإنشاء تمرين كتابة موجه لك.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="repressed-feelings" class="block text-right font-semibold mb-2">المشاعر المكبوتة أو الصدمة</label>
                                         <textarea id="repressed-feelings" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: أشعر بغضب مكبوت تجاه موقف معين..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أنشئ التمرين</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'consultation':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">استشارة طبية آلية</h3>
                                 <p class="text-gray-600 mb-6">اطرح سؤالك على مساعد د. عمر الذكي للحصول على إجابات تستند إلى مبادئ الطب الشمولي.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="question" class="block text-right font-semibold mb-2">سؤالك</label>
                                         <textarea id="question" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: ما هي أفضل الطرق لتقوية المناعة بشكل طبيعي؟"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على الإجابة</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'supplements':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">توصية مكملات غذائية</h3>
                                 <p class="text-gray-600 mb-6">صف أعراضك أو الصق نتائج تحليل الدم هنا، وسيقوم المساعد الذكي بتحليلها وتقديم توصيات للمكملات الغذائية.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="analysis-data" class="block text-right font-semibold mb-2">الأعراض أو نتائج التحليل</label>
                                         <textarea id="analysis-data" rows="5" class="w-full p-2 border rounded-md" placeholder="مثال: أعاني من تساقط الشعر، إرهاق مستمر..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على توصية</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'intention':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">نية اليوم</h3>
                                 <p class="text-gray-600 mb-6">احصل على نية إيجابية ومركزة لدعمك في يومك.</p>
                                 <form id="tool-form">
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أعطني نيتي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                    }
                    showModal(modalHTML);
                    const form = document.getElementById('tool-form');
                    if (form) form.addEventListener('submit', (e) => handleToolSubmit(e, tool));
                });
            });

            async function handleApiRequest(prompt, resultsDivId) {
                const resultsDiv = document.getElementById(resultsDivId);
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = `<div class="ai-loader"><div class="ai-loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div><p class="mt-4 text-[--primary-color]">جاري التحليل...</p></div>`;
                
                // The API key is injected by the environment at runtime.
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content.parts.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else { throw new Error("Invalid API response structure"); }
                } catch (error) {
                    console.error("API Request Error:", error);
                    resultsDiv.innerHTML = '<p class="text-center text-red-500">حدث خطأ. يرجى المحاولة مرة أخرى.</p>';
                    return null;
                }
            }
            
            async function handleToolSubmit(e, tool) {
                e.preventDefault();
                let prompt = '', toolTitle = '', rawInputForSaving = '';
                 switch(tool) {
                     case 'blood-test-decoder':
                         toolTitle = "فك شفرة تحاليل الدم";
                         const bloodTestData = document.getElementById('blood-test-data').value;
                         rawInputForSaving = `بيانات التحليل: ${bloodTestData}`;
                         if (!bloodTestData) { showNotification('يرجى لصق نتائج التحليل.', 'warning'); return; }
                         prompt = `Act as a functional medicine expert analyzing blood test results. The user has provided these results: "${bloodTestData}". Your task is to:
1.  Identify key markers (like Vitamin D, Ferritin, TSH, etc.).
2.  For each marker, state its functional/optimal range (which is often stricter than the standard lab range).
3.  Compare the user's result to the optimal range.
4.  Explain in simple Arabic what this result means for their health from a holistic perspective (e.g., how low ferritin affects energy and hair).
5.  Provide actionable recommendations including specific foods, lifestyle changes, and potential supplements to help them reach the optimal range.
Structure the output in Arabic with clear headings for each marker using markdown. Start with a disclaimer that this is not a medical diagnosis.`;
                         break;
                     case 'diagnosis':
                         toolTitle = "تشخيص متعدد الأبعاد";
                         const symptoms = document.getElementById('symptoms').value;
                         const feelings = document.getElementById('feelings').value;
                         const lifestyle = document.getElementById('lifestyle').value;
                         rawInputForSaving = `الأعراض: ${symptoms}\nالمشاعر: ${feelings}\nنمط الحياة: ${lifestyle}`;
                         if (!symptoms && !feelings && !lifestyle) { showNotification('يرجى إدخال بعض المعلومات للتحليل.', 'warning'); return; }
                         prompt = `Act as a holistic medicine expert. Analyze the user's input based on a tripartite model (organic, emotional, energetic) and provide a probable diagnosis or assessment. User Input -> Symptoms: "${symptoms}", Feelings: "${feelings}", Lifestyle: "${lifestyle}". Structure the output as a clean, readable text in Arabic with three main sections: "الاحتمال العضوي", "الجذر الشعوري", and "التوازن الطاقي المختل". Use markdown for formatting.`;
                         break;
                     case 'treatment-plan':
                         toolTitle = "وصفة علاجية شمولية";
                         const diagnosisInput = document.getElementById('diagnosis-input').value;
                         rawInputForSaving = `التشخيص: ${diagnosisInput}`;
                         if (!diagnosisInput) { showNotification('يرجى إدخال التشخيص أو الأعراض الرئيسية.', 'warning'); return; }
                         prompt = `As a functional medicine doctor, design a comprehensive 21-day holistic treatment plan for a patient with the following diagnosis/symptoms: "${diagnosisInput}". The plan should include sections for: "الأدوية أو المكملات المقترحة", "توصيات التغذية", "تمارين تأمل أو وعي", and "نصائح طاقة ونمط حياة". Present the output in a well-structured, easy-to-read format in Arabic using markdown.`;
                         break;
                     case 'awareness-exercise':
                         toolTitle = "تمرين وعي موجّه";
                         const repressedFeelings = document.getElementById('repressed-feelings').value;
                         rawInputForSaving = `المشاعر: ${repressedFeelings}`;
                         if (!repressedFeelings) { showNotification('يرجى وصف مشاعرك.', 'warning'); return; }
                         prompt = `You are a therapeutic writing coach. Based on the user's stated repressed feelings: "${repressedFeelings}", create a guided expressive writing exercise. The output should be in Arabic and include: 1. A gentle introduction. 2. A series of 3-5 reflective writing prompts. 3. A concluding guidance on how to process what they've written. Format the output with clear headings using markdown.`;
                         break;
                     case 'consultation':
                         toolTitle = "استشارة طبية آلية";
                         const question = document.getElementById('question').value;
                         rawInputForSaving = `السؤال: ${question}`;
                         if (!question) { showNotification('يرجى كتابة سؤالك.', 'warning'); return; }
                         prompt = `As a holistic medicine assistant for Dr. Omar, answer the following question in Arabic, incorporating principles of holistic, functional, and spiritual medicine where appropriate. Question: "${question}"`;
                         break;
                     case 'supplements':
                          toolTitle = "توصية مكملات غذائية";
                         const analysisData = document.getElementById('analysis-data').value;
                         rawInputForSaving = `البيانات: ${analysisData}`;
                         if (!analysisData) { showNotification('يرجى إدخال الأعراض أو نتائج التحليل.', 'warning'); return; }
                         prompt = `As a functional medicine expert, analyze the provided symptoms or blood test results: "${analysisData}" and recommend the most effective supplements. Include recommended timing (e.g., with food, in the morning) and any potential warnings. The output should be a clear, bulleted list in Arabic.`;
                         break;
                     case 'intention':
                         toolTitle = "نية اليوم";
                         rawInputForSaving = `طلب نية اليوم`;
                         prompt = `As a spiritual wellness coach, provide a supportive, healing daily intention for the user. The output should be a single, powerful intention sentence in Arabic, followed by a short (1-2 sentences) "تمرين دعم داخلي" to help them embody that intention.`;
                         break;
                }
                const responseText = await handleApiRequest(prompt, 'tool-results');
                if (responseText) {
                    const resultsDiv = document.getElementById('tool-results');
                    resultsDiv.innerHTML = `
                        <div id="result-content" class="p-4 bg-gray-50 rounded-md text-right whitespace-pre-wrap border">${responseText}</div>
                        <div class="mt-4 text-left">
                            ${currentUser ? '<button id="save-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ النتيجة</button>' : ''}
                            <button id="download-pdf-btn" class="btn btn-primary text-white py-2 px-4 rounded-full mr-2 text-sm">تحميل كـ PDF</button>
                        </div>`;
                    if (currentUser) {
                         document.getElementById('save-result-btn').addEventListener('click', () => {
                             const fullResultText = `--- المدخلات ---\n${rawInputForSaving}\n\n--- نتيجة التحليل ---\n${responseText}`;
                             saveResultToFirestore(toolTitle, fullResultText)
                         });
                    }
                    document.getElementById('download-pdf-btn').addEventListener('click', () => downloadResultAsPDF('result-content', toolTitle));
                }
            }
        }
        
        // --- PDF DOWNLOAD MODULE ---
        function downloadResultAsPDF(elementId, title) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);
            if (!element) return;
            showNotification("جاري إعداد ملف الـ PDF...", 'warning', 2000);
            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                pdf.setProperties({ title: `تقرير ${title} - د. عمر العماد`, author: 'موقع د. عمر العماد - TibraSoul' });
                // Note: jsPDF might not support Arabic fonts by default. This is a basic implementation.
                // For full Arabic support, a custom font needs to be added to jsPDF.
                const pdfWidth = pdf.internal.pageSize.getWidth();
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, 0);
                pdf.save(`${title.replace(/\s+/g, '-')}_${new Date().toISOString().split('T')[0]}.pdf`);
            });
        }

        // --- FREQUENCY GENERATOR MODULE ---
        function initFrequencyGenerator() {
            const freqButtonsContainer = document.getElementById('frequency-buttons');
            const stopFreqBtn = document.getElementById('stop-freq-btn');
            const canvas = document.getElementById('frequency-canvas');
            if (!freqButtonsContainer || !stopFreqBtn || !canvas) return;
            let audioContext, oscillator, analyser, gainNode, animationFrameId;
            const canvasCtx = canvas.getContext('2d');
            
            const setupAudio = async () => {
                 if (!audioContext) {
                    try {
                        await Tone.start();
                        audioContext = Tone.context;
                        analyser = audioContext.createAnalyser();
                        gainNode = audioContext.createGain();
                        analyser.fftSize = 2048;
                        gainNode.connect(analyser);
                        analyser.connect(audioContext.destination);
                        console.log("Audio Context is ready.");
                    } catch (e) {
                        console.error("Could not start Audio Context: ", e);
                        showNotification("لا يمكن تشغيل الصوت. يرجى التفاعل مع الصفحة أولاً.", "error");
                    }
                }
            };
            
            const playFrequency = async (freq) => {
                 await setupAudio();
                if (!audioContext) return;

                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                }

                oscillator = new Tone.Oscillator(freq, "sine").connect(gainNode);
                oscillator.start();
                gainNode.gain.rampTo(0.5, 0.1); // Ramp up volume
                stopFreqBtn.classList.remove('hidden');
                visualize();
            };
            
            const stopFrequency = () => {
                if (oscillator) {
                    gainNode.gain.rampTo(0, 0.5); // Ramp down volume
                    setTimeout(() => {
                        oscillator.stop();
                        oscillator.disconnect();
                        oscillator = null;
                        cancelAnimationFrame(animationFrameId);
                        clearCanvas();
                    }, 500);
                }
                stopFreqBtn.classList.add('hidden');
                document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
            };
            
            function visualize() {
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    animationFrameId = requestAnimationFrame(draw);
                    analyser.getByteTimeDomainData(dataArray);
                    
                    canvasCtx.fillStyle = '#1a1a1a';
                    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                    canvasCtx.lineWidth = 2;
                    canvasCtx.strokeStyle = 'rgb(200, 160, 125)';
                    canvasCtx.beginPath();
                    
                    const sliceWidth = canvas.width * 1.0 / bufferLength;
                    let x = 0;
                    
                    for(let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * canvas.height / 2;
                        if(i === 0) {
                            canvasCtx.moveTo(x, y);
                        } else {
                            canvasCtx.lineTo(x, y);
                        }
                        x += sliceWidth;
                    }
                    
                    canvasCtx.lineTo(canvas.width, canvas.height / 2);
                    canvasCtx.stroke();
                };
                draw();
            }

            const clearCanvas = () => {
                canvasCtx.fillStyle = '#1a1a1a';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                canvasCtx.lineWidth = 1;
                canvasCtx.strokeStyle = '#333';
                canvasCtx.beginPath();
                canvasCtx.moveTo(0, canvas.height / 2);
                canvasCtx.lineTo(canvas.width, canvas.height / 2);
                canvasCtx.stroke();
            };
            
            freqButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.freq-btn');
                if (button) {
                     document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
                     button.classList.add('active');
                    const freq = parseFloat(button.dataset.freq);
                    playFrequency(freq);
                }
            });
            
            stopFreqBtn.addEventListener('click', stopFrequency);
            clearCanvas();
        }

        // --- BLOG MODULE ---
        function initBlog() {
            const posts = {
                'gut-brain': { 
                    title: 'هل أمعاؤك هي سبب تقلبات مزاجك؟', 
                    image: 'https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070&auto=format&fit=crop', 
                    content: `
                        <h2>العلاقة الخفية بين القناة الهضمية والدماغ</h2>
                        <p>هل تعلم أن أمعاءك يطلق عليها "الدماغ الثاني"؟ هذا ليس مجرد تعبير مجازي. يوجد اتصال مباشر ومعقد بين دماغك وجهازك الهضمي، يُعرف باسم محور الأمعاء-الدماغ. هذا المحور هو طريق سريع ثنائي الاتجاه، حيث ترسل الأمعاء إشارات إلى الدماغ والعكس صحيح.</p>
                        <p>ما يقرب من 80-90% من السيروتونين في الجسم، وهو ناقل عصبي رئيسي مسؤول عن الشعور بالسعادة والرفاهية، يتم إنتاجه في القناة الهضمية. عندما يكون الميكروبيوم المعوي (مجموعة البكتيريا والكائنات الحية الدقيقة الأخرى في أمعائك) غير متوازن، يمكن أن يؤثر ذلك بشكل مباشر على إنتاج السيروتونين، مما يؤدي إلى تقلبات مزاجية، قلق، وحتى اكتئاب.</p>
                        <h2>كيف تدعم هذا المحور الهام؟</h2>
                        <ul>
                            <li><strong>تغذية غنية بالألياف:</strong> تغذي الألياف البكتيريا المفيدة في أمعائك. ركز على الخضروات والفواكه والبقوليات.</li>
                            <li><strong>الأطعمة المخمرة:</strong> الزبادي، الكفير، مخلل الملفوف هي مصادر ممتازة للبروبيوتيك (البكتيريا الجيدة).</li>
                            <li><strong>تقليل السكر والأطعمة المصنعة:</strong> هذه الأطعمة تغذي البكتيريا الضارة وتسبب الالتهابات.</li>
                            <li><strong>إدارة الإجهاد:</strong> الإجهاد المزمن يمكن أن يضر ببطانة الأمعاء ويخل بتوازن الميكروبيوم. مارس التأمل، التنفس العميق، أو اليوجا.</li>
                        </ul>
                        <p>الاهتمام بصحة أمعائك ليس فقط لتحسين الهضم، بل هو خطوة أساسية نحو صحة نفسية وعقلية أفضل. ابدأ اليوم بإجراء تغيير صغير واحد، وشاهد كيف يتغير شعورك.</p>
                    ` 
                },
                'breathing': { 
                    title: 'قوة التنفس: كيف تهدئ جهازك العصبي في 5 دقائق', 
                    image: 'https://images.unsplash.com/photo-1599301934984-1d2741913a5f?q=80&w=2070&auto=format&fit=crop', 
                    content: 'محتوى المقال عن التنفس...' 
                },
                'supplements': { 
                    title: 'أفضل 3 مكملات غذائية لمكافحة الالتهابات', 
                    image: 'https://images.unsplash.com/photo-1476837579993-f1d3948f17c2?q=80&w=2070&auto=format&fit=crop', 
                    content: 'محتوى المقال عن المكملات...' 
                }
            };
            document.querySelectorAll('.read-more-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const postId = button.dataset.postid;
                    const post = posts[postId];
                    if (post) {
                        document.getElementById('post-title').textContent = post.title;
                        document.getElementById('post-image').src = post.image;
                        document.getElementById('post-image').alt = post.title;
                        document.getElementById('post-content').innerHTML = post.content;
                        showView('single-post');
                    }
                });
            });
        }

        // --- WHEEL OF LIFE MODULE ---
        function initWheelOfLife() {
            const ctx = document.getElementById('wheel-of-life-chart');
            if (!ctx) return;
            const slidersContainer = document.getElementById('wheel-of-life-sliders');
            const getInsightBtn = document.getElementById('get-wheel-insight-btn');
            const resultDiv = document.getElementById('wheel-of-life-result');

            const labels = ['الصحة الجسدية', 'النمو الشخصي', 'الحياة المهنية', 'المالية', 'البيئة المحيطة', 'المرح والاستجمام', 'العلاقات الأسرية والاجتماعية', 'الحياة الروحية'];
            const initialData = Array(labels.length).fill(5);
            
            // Create sliders
            labels.forEach((label, index) => {
                const sliderHTML = `
                    <div class="flex items-center gap-4">
                        <label for="slider-${index}" class="w-1/3 text-right">${label}</label>
                        <input type="range" id="slider-${index}" min="0" max="10" value="5" class="range-slider flex-grow" data-index="${index}">
                        <span id="value-${index}" class="w-8 text-center font-bold">${initialData[index]}</span>
                    </div>`;
                slidersContainer.innerHTML += sliderHTML;
            });
            
            // Chart initialization
            wheelChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تقييمي الحالي',
                        data: initialData,
                        fill: true,
                        backgroundColor: 'rgba(200, 160, 125, 0.4)',
                        borderColor: 'rgb(200, 160, 125)',
                        pointBackgroundColor: 'rgb(200, 160, 125)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(200, 160, 125)'
                    }]
                },
                options: {
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(90, 110, 90, 0.3)'
                            },
                            grid: {
                                color: 'rgba(90, 110, 90, 0.3)'
                            },
                            pointLabels: {
                                font: {
                                    family: "'Noto Kufi Arabic', sans-serif",
                                    size: 13
                                },
                                color: '#333'
                            },
                            ticks: {
                                backdropColor: 'var(--secondary-color)',
                                color: '#555',
                                stepSize: 2
                            },
                            suggestedMin: 0,
                            suggestedMax: 10
                        }
                    },
                    plugins: {
                        legend: {
                           display: false
                        }
                    }
                }
            });

            // Event listeners
            slidersContainer.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const index = e.target.dataset.index;
                    const value = e.target.value;
                    document.getElementById(`value-${index}`).textContent = value;
                    wheelChart.data.datasets[0].data[index] = value;
                    wheelChart.update();
                }
            });
            
            getInsightBtn.addEventListener('click', getWheelInsight);
        }
        
        async function getWheelInsight() {
            const resultDiv = document.getElementById('wheel-of-life-result');
            const data = wheelChart.data.datasets[0].data;
            const labels = wheelChart.data.labels;
            
            resultDiv.classList.remove('hidden');
            resultDiv.style.opacity = '0';
            resultDiv.innerHTML = `<div class="ai-loader"><div class="ai-loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div><p class="mt-4 text-[--primary-color]">جاري تحليل عجلة حياتك...</p></div>`;

            let userInput = "User's Wheel of Life scores are: ";
            labels.forEach((label, index) => {
                userInput += `${label}: ${data[index]}/10, `;
            });

            const prompt = `Act as a wise and compassionate holistic life coach. Based on the user's Wheel of Life scores: [${userInput}]. Your task is to:
1.  Identify the top 2-3 highest scoring areas and acknowledge them as strengths.
2.  Identify the top 2-3 lowest scoring areas and frame them as opportunities for growth, not failures.
3.  Provide one insightful, holistic observation about the potential interplay between the high and low areas (e.g., "I notice your career score is high, but your health is low. Perhaps your professional success is coming at the expense of your physical wellbeing?").
4.  Offer one simple, actionable first step for one of the lowest areas.
5.  End with an encouraging and empowering message.
The entire response should be in warm, supportive Arabic. Start with a positive affirmation. Use markdown for lists and bolding.`;
            
            const insightText = await handleApiRequest(prompt, 'wheel-of-life-result'); // uses a different function
             if (insightText) {
                resultDiv.innerHTML = `
                    <div id="wheel-result-content" class="text-right whitespace-pre-wrap">${insightText}</div>
                    <div class="mt-4 text-center">
                        ${currentUser ? '<button id="save-wheel-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ النتيجة في ملفي</button>' : '<p class="text-sm text-gray-500">سجل الدخول لحفظ هذه الرؤى القيمة!</p>'}
                    </div>`;
                if(currentUser) {
                    document.getElementById('save-wheel-result-btn').addEventListener('click', () => {
                         const fullResultText = `--- تقييم عجلة العافية ---\n${userInput}\n\n--- رؤى التحليل ---\n${insightText}`;
                         saveResultToFirestore("تحليل عجلة العافية", fullResultText);
                    });
                }
             } else {
                 resultDiv.innerHTML = '<p class="text-center text-red-500">حدث خطأ أثناء توليد التحليل. يرجى المحاولة مرة أخرى.</p>';
             }
             resultDiv.style.opacity = '1';

             async function handleApiRequest(prompt, resultsDivId) { // Local definition to avoid conflict
                const resultsDiv = document.getElementById(resultsDivId);
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content.parts.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else { throw new Error("Invalid API response structure"); }
                } catch (error) {
                    console.error("API Request Error:", error);
                    resultsDiv.innerHTML = '<p class="text-center text-red-500">حدث خطأ. يرجى المحاولة مرة أخرى.</p>';
                    return null;
                }
            }
        }
        
        // --- AUDIO PLAYER MODULE ---
        function initAudioPlayer() {
             const audio = document.getElementById('guided-audio');
            if(!audio) return;
            const playPauseBtn = document.getElementById('audio-play-pause-btn');
            const playIcon = playPauseBtn.querySelector('i');
            const progressBar = document.getElementById('audio-progress-bar');
            const timeDisplay = document.getElementById('audio-time');
            const totalDuration = 60; // 1 minute

            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            };

            playPauseBtn.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play();
                    playIcon.classList.replace('fa-play-circle', 'fa-pause-circle');
                } else {
                    audio.pause();
                    playIcon.classList.replace('fa-pause-circle', 'fa-play-circle');
                }
            });

            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.value = progress;
                timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(totalDuration)}`;
            });

            audio.addEventListener('ended', () => {
                playIcon.classList.replace('fa-pause-circle', 'fa-play-circle');
                progressBar.value = 0;
                timeDisplay.textContent = `00:00 / ${formatTime(totalDuration)}`;
            });

            progressBar.addEventListener('input', () => {
                const seekTime = (progressBar.value / 100) * audio.duration;
                audio.currentTime = seekTime;
            });
        }

        // --- GENERAL UI & CREATIVE EFFECTS ---
        function initGeneralUI() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            mobileMenu.addEventListener('click', (e) => { 
                if(e.target.classList.contains('nav-link') || e.target.closest('.nav-link')){
                     mobileMenu.classList.add('hidden');
                }
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('is-visible');
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
        }

        function initCreativeEffects() {
            const cards = document.querySelectorAll('.dashboard-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const rotateX = ((y - card.offsetHeight / 2) / (card.offsetHeight / 2)) * -5;
                    const rotateY = ((x - card.offsetWidth / 2) / (card.offsetWidth / 2)) * 5;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', function(e) {
                     const rect = this.getBoundingClientRect();
                     const ripple = document.createElement('span');
                     const d = Math.max(this.clientWidth, this.clientHeight);
                     ripple.style.width = ripple.style.height = d + 'px';
                     ripple.style.left = e.clientX - rect.left - d/2 + 'px';
                     ripple.style.top = e.clientY - rect.top - d/2 + 'px';
                     ripple.classList.add('ripple');
                     this.appendChild(ripple);
                     setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // --- BODY MAP MODULE (NEW) ---
        function initBodyMap() {
            const infoContainer = document.getElementById('body-map-info');
            const organNameEl = document.getElementById('organ-name');
            const organDetailsEl = document.getElementById('organ-details');
            if (!infoContainer) return;

            const organData = {
                brain: {
                    name: 'الدماغ والجهاز العصبي',
                    content: `
                        <p class="mb-2"><strong>منظور شمولي:</strong> ليس فقط مركز القيادة، بل هو جهاز استقبال وبث للطاقة والأفكار. يرتبط ارتباطاً وثيقاً بصحة الأمعاء (محور الأمعاء-الدماغ).</p>
                        <p class="mb-2"><strong>أعراض الخلل:</strong> ضبابية الدماغ، ضعف الذاكرة، القلق، الاكتئاب، الصداع، الأرق.</p>
                        <p class="mb-2"><strong>كيف تدعمه:</strong> دهون صحية (أوميغا-3)، تأمل، نوم عميق، تقليل المحفزات الزرقاء ليلاً، تعلم أشياء جديدة.</p>`
                },
                thyroid: {
                    name: 'الغدة الدرقية',
                    content: `<p class="mb-2"><strong>منظور شمولي:</strong> هي منظم طاقة الجسم وصوتك الحقيقي في العالم. تتحكم في معدل الأيض وكيفية استخدامك للطاقة.</p>
                        <p class="mb-2"><strong>أعراض الخلل:</strong> تعب مزمن، زيادة أو نقصان في الوزن، تساقط الشعر، حساسية للبرد، تقلبات مزاجية.</p>
                        <p class="mb-2"><strong>كيف تدعمها:</strong> اليود والسيلينيوم والزنك، تجنب الإجهاد المزمن، تقليل الغلوتين ومنتجات الألبان إذا كنت تعاني من حساسية.</p>`
                },
                heart: {
                    name: 'القلب',
                    content: `<p class="mb-2"><strong>منظور شمولي:</strong> مركز الحب والاتصال والرحمة. ليس مجرد مضخة، بل له حقله الكهرومغناطيسي الخاص به والذي يؤثر على كل خلية.</p>
                        <p class="mb-2"><strong>أعراض الخلل:</strong> ارتفاع ضغط الدم، خفقان، الشعور بالانفصال، صعوبة في العطاء أو تلقي الحب.</p>
                        <p class="mb-2"><strong>كيف تدعمه:</strong> ممارسة الامتنان، قضاء وقت مع الأحباء، تمارين الكارديو المعتدلة، CoQ10، المغنيسيوم.</p>`
                },
                liver: {
                    name: 'الكبد',
                    content: `<p class="mb-2"><strong>منظور شمولي:</strong> هو مختبر الجسم الكيميائي ومركز معالجة السموم والمشاعر المكبوتة مثل الغضب والإحباط.</p>
                        <p class="mb-2"><strong>أعراض الخلل:</strong> مشاكل جلدية (حب الشباب، أكزيما)، تعب، صعوبة في هضم الدهون، حساسية كيميائية، غضب مكبوت.</p>
                        <p class="mb-2"><strong>كيف تدعمه:</strong> خضروات صليبية (بروكلي، قرنبيط)، الشمندر، الكركم، الشاي الأخضر، تقنيات التحرر من الغضب.</p>`
                },
                gut: {
                    name: 'الأمعاء (الجهاز الهضمي)',
                    content: `<p class="mb-2"><strong>منظور شمولي:</strong> "عقلك الثاني"، حيث يتم امتصاص العناصر الغذائية وتصنيع 80% من السيروتونين. صحة الأمعاء هي أساس صحة الجسم كله.</p>
                        <p class="mb-2"><strong>أعراض الخلل:</strong> انتفاخ، غازات، إمساك أو إسهال، حساسية غذائية، أمراض مناعية ذاتية، مشاكل جلدية، قلق واكتئاب.</p>
                        <p class="mb-2"><strong>كيف تدعمها:</strong> بروبيوتيك وبريبيوتيك، مرق العظام، الأطعمة المخمرة، تجنب الأطعمة المصنعة والسكر، إدارة التوتر.</p>`
                },
                adrenals: {
                    name: 'الغدد الكظرية',
                    content: `<p class="mb-2"><strong>منظور شمولي:</strong> بطاريات طاقتك ومدير استجابتك للإجهاد والتوتر. تنتج هرمونات مثل الكورتيزول والأدرينالين.</p>
                        <p class="mb-2"><strong>أعراض الخلل:</strong> إرهاق كظري، تعب صباحي وصعوبة في الاستيقاظ، رغبة شديدة في الملح والسكر، ضعف المناعة، دوخة عند الوقوف.</p>
                        <p class="mb-2"><strong>كيف تدعمها:</strong> إدارة الإجهاد (أساسي)، نوم كافٍ، فيتامين سي ومجموعة فيتامينات ب، أعشاب متكيفة (أشواغاندا)، إضافة ملح بحري عالي الجودة للطعام.</p>`
                }
            };
            
            document.querySelectorAll('#body-map-svg .organ').forEach(organ => {
                organ.addEventListener('click', () => {
                    const organKey = organ.dataset.organ;
                    const data = organData[organKey];

                    if (data) {
                        infoContainer.style.opacity = 0;
                        infoContainer.style.transform = 'translateY(20px)';
                        
                        setTimeout(() => {
                            organNameEl.textContent = data.name;
                            organDetailsEl.innerHTML = data.content;
                            infoContainer.style.opacity = 1;
                            infoContainer.style.transform = 'translateY(0)';
                        }, 300);
                    }
                });
            });
        }
        
        // --- QUIZZES MODULE (NEW) ---
        function initQuizzes() {
            const modal = document.getElementById('quiz-modal');
            const modalContent = document.getElementById('quiz-modal-content');

            const quizzes = {
                'adrenal-fatigue': {
                    title: 'اختبار الإرهاق الكظري',
                    questions: [
                        { q: "هل تشعر بالتعب حتى بعد ليلة نوم كاملة؟", points: 2 },
                        { q: "هل تجد صعوبة في الاستيقاظ في الصباح؟", points: 2 },
                        { q: "هل تشتهي الأطعمة المالحة أو السكرية بشدة؟", points: 2 },
                        { q: "هل تشعر بالدوار أو الدوخة عند الوقوف بسرعة؟", points: 1 },
                        { q: "هل قدرتك على التعامل مع الإجهاد منخفضة؟", points: 2 },
                        { q: "هل تمرض بسهولة وتستغرق وقتاً أطول للشفاء؟", points: 1 },
                        { q: "هل تشعر بأن لديك طاقة أفضل في المساء؟", points: 1 },
                    ],
                    results: [
                        { score: 0, text: "احتمالية منخفضة لوجود إرهاق كظري. يبدو أن غددك الكظرية تعمل بشكل جيد. حافظ على نمط حياتك الصحي!" },
                        { score: 4, text: "احتمالية متوسطة لوجود إرهاق كظري. قد تكون غددك الكظرية تحت ضغط. من الجيد البدء في تطبيق تقنيات إدارة الإجهاد والنوم بشكل أفضل." },
                        { score: 7, text: "احتمالية عالية لوجود إرهاق كظري. غددك الكظرية بحاجة ماسة للدعم. نوصي بشدة بالتركيز على إدارة الإجهاد، التغذية الداعمة، والنوم. قد يكون من المفيد حجز استشارة لمناقشة النتائج." }
                    ]
                }
            };

            const hideQuizModal = () => {
                modal.classList.remove('is-open');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            document.querySelectorAll('.quiz-start-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const quizId = btn.dataset.quiz;
                    startQuiz(quizId);
                });
            });
            
            function startQuiz(quizId) {
                const quizData = quizzes[quizId];
                let currentQuestion = 0;
                let score = 0;

                function renderQuestion() {
                    if (currentQuestion >= quizData.questions.length) {
                        renderResult();
                        return;
                    }
                    const q = quizData.questions[currentQuestion];
                    modalContent.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2">${quizData.title}</h3>
                        <p class="text-gray-500 mb-6">السؤال ${currentQuestion + 1} من ${quizData.questions.length}</p>
                        <p class="text-xl font-semibold mb-6 text-center">${q.q}</p>
                        <div class="flex justify-center gap-4">
                           <button class="quiz-answer-btn btn btn-primary text-white py-2 px-8 rounded-full" data-answer="yes">نعم</button>
                           <button class="quiz-answer-btn btn btn-secondary py-2 px-8 rounded-full" data-answer="no">لا</button>
                        </div>
                    `;
                    document.querySelectorAll('.quiz-answer-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            if (e.target.dataset.answer === 'yes') {
                                score += q.points;
                            }
                            currentQuestion++;
                            renderQuestion();
                        });
                    });
                }
                
                function renderResult() {
                    let resultText = '';
                    for (let i = quizData.results.length - 1; i >= 0; i--) {
                        if (score >= quizData.results[i].score) {
                            resultText = quizData.results[i].text;
                            break;
                        }
                    }
                     modalContent.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2">النتيجة</h3>
                        <div class="bg-gray-100 p-6 rounded-lg text-center">
                            <p class="text-lg mb-2">درجتك هي: <span class="font-bold text-2xl text-[--primary-color]">${score}</span></p>
                            <p class="text-gray-700">${resultText}</p>
                        </div>
                        <div class="text-center mt-6">
                            <button class="close-quiz-modal-btn btn btn-primary text-white py-2 px-6 rounded-full">إغلاق</button>
                        </div>
                    `;
                    modalContent.querySelector('.close-quiz-modal-btn').addEventListener('click', hideQuizModal);
                }
                
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('is-open'), 10);
                renderQuestion();
            }
        }

        // --- JOURNAL MODULE (NEW) ---
        function initJournal() {
            const form = document.getElementById('journal-form');
            if(!form) return;

            document.getElementById('entry-date').valueAsDate = new Date();

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showNotification("يجب تسجيل الدخول لحفظ الإدخالات.", "error");
                    return;
                }
                const entry = {
                    date: document.getElementById('entry-date').value,
                    mood: document.getElementById('mood-rating').value,
                    energy: document.getElementById('energy-rating').value,
                    sleep: document.getElementById('sleep-quality').value,
                    symptoms: document.getElementById('symptoms-today').value,
                    createdAt: new Date()
                };

                try {
                    const journalCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journalEntries');
                    await addDoc(journalCollection, entry);
                    showNotification("تم حفظ الإدخال بنجاح!", "success");
                    form.reset();
                    document.getElementById('entry-date').valueAsDate = new Date();
                    loadJournalEntries(); 
                } catch (error) {
                    console.error("Error saving journal entry: ", error);
                    showNotification("حدث خطأ أثناء حفظ الإدخال.", "error");
                }
            });
        }
        
        function toggleJournalView(isLoggedIn) {
            document.getElementById('journal-content-container').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('journal-login-prompt').classList.toggle('hidden', isLoggedIn);
        }

        async function loadJournalEntries() {
            if (!currentUser) return;
            const entriesContainer = document.getElementById('journal-entries-container');
            entriesContainer.innerHTML = '<p>جاري تحميل السجلات...</p>';

            const journalCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journalEntries');
            const q = query(journalCollection, orderBy("date", "desc"), limit(30));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                entriesContainer.innerHTML = '<p>لا توجد إدخالات بعد. ابدأ بتسجيل يومك!</p>';
                if(journalChart) journalChart.destroy();
                return;
            }
            
            const entries = [];
            let entriesHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                entries.push(data);
                entriesHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-sm journal-entry">
                        <p class="font-bold text-lg">${data.date}</p>
                        <p class="text-sm"><strong>المزاج:</strong> ${data.mood}/10 | <strong>الطاقة:</strong> ${data.energy}/10 | <strong>النوم:</strong> ${data.sleep || 'N/A'} س</p>
                        ${data.symptoms ? `<p class="text-sm text-gray-600 mt-1"><strong>الأعراض:</strong> ${data.symptoms}</p>` : ''}
                    </div>`;
            });
            entriesContainer.innerHTML = entriesHTML;
            renderJournalChart(entries.reverse());
        }

        function renderJournalChart(entries) {
            const ctx = document.getElementById('journal-chart').getContext('2d');
            if (journalChart) {
                journalChart.destroy();
            }
            journalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: entries.map(e => e.date),
                    datasets: [
                        {
                            label: 'مستوى المزاج',
                            data: entries.map(e => e.mood),
                            borderColor: 'rgb(200, 160, 125)',
                            backgroundColor: 'rgba(200, 160, 125, 0.5)',
                            tension: 0.1
                        },
                        {
                            label: 'مستوى الطاقة',
                            data: entries.map(e => e.energy),
                            borderColor: 'rgb(90, 110, 90)',
                            backgroundColor: 'rgba(90, 110, 90, 0.5)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            });
        }
    </script>
</body>
</html>
